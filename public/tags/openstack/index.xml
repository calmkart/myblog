<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Openstack on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/openstack/</link>
        <description>Recent content in Openstack on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Thu, 03 Aug 2017 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/openstack/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>openstack部署指南(devstack/newton)</title>
            <link>http://localhost:1313/posts/2017/08/2017-08-03-openstack%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97devstacknewton/</link>
            <pubDate>Thu, 03 Aug 2017 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2017/08/2017-08-03-openstack%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97devstacknewton/</guid>
            <description>&lt;h1 id=&#34;1部署环境&#34;&gt;1.部署环境&#xA;&lt;/h1&gt;&lt;p&gt;本次openstack部署环境为三台服务器，系统统一为ubuntu16.04 server。三台服务器分别为R730，R720，R710，其中R730作为控制节点+网络节点+计算节点，R710与R720作为计算节点。&lt;/p&gt;&#xA;&lt;p&gt;部署环境如下图所示： &lt;img src=&#34;images/QerThQ3lh1t69wOLWlXP3g.png&#34; alt=&#34;&#34; /&gt;&#xA; 其中各机器eth1网卡为管理及API网络（同时也是部署与下载网络），eth2网卡为虚拟机内部租户网络，控制节点R730服务器的eth2网卡为用来上网的外部网络。&lt;/p&gt;&#xA;&lt;p&gt;其中各节点安装服务列表如下： (R730)Devstack-controller：Keystone,Glance,Cinder,Neutron,Nova&amp;hellip;.. (R720)Devstack-compute-1：KVM Hypervisor,Nova,Neutron agent&amp;hellip;. (R710)Devstack-compute-2：KVM Hypervisor,Nova,Neutron agent&amp;hellip;.&lt;/p&gt;&#xA;&lt;h1 id=&#34;2控制节点网络拓扑&#34;&gt;2.控制节点网络拓扑&#xA;&lt;/h1&gt;&lt;p&gt;&lt;img src=&#34;images/%e7%81%ab%e6%98%9f%e5%9b%be%e7%89%87_20170803_141421.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;外网网卡eth2绑定OVS外部网络网桥Br-ex，再通过虚拟路由器连接内部OVS网桥Br-int与Br-ex，实现内部虚拟机与外部的通信。 但由于虚拟路由默认自带DHCP功能，会污染外部网络，所以目前的做法是将虚拟路由的DHCP功能关闭，为内部一台跳板机手动配置IP，然后所有内部虚拟机通过此跳板机访问。&lt;/p&gt;&#xA;&lt;h1 id=&#34;3部署过程细节&#34;&gt;3.部署过程细节&#xA;&lt;/h1&gt;&lt;h2 id=&#34;1为各台服务器配置网卡参数&#34;&gt;1.为各台服务器配置网卡参数&#xA;&lt;/h2&gt;&lt;p&gt;/etc/network/interfaces&lt;/p&gt;&#xA;&lt;p&gt;R730： &lt;img src=&#34;images/1.png&#34; alt=&#34;&#34; /&gt;&#xA; R720： &lt;img src=&#34;images/2.png&#34; alt=&#34;&#34; /&gt;&#xA; R710： &lt;img src=&#34;images/3.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;重启机器&lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;h2 id=&#34;2配置devstack相关环境&#34;&gt;2.配置devstack相关环境&#xA;&lt;/h2&gt;&lt;h3 id=&#34;1配置中国的镜像源&#34;&gt;1.配置中国的镜像源&#xA;&lt;/h3&gt;&lt;p&gt;Vi /etc/apt/sources.list&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse&#xA;deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse&#xA;deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse&#xA;deb http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse&#xA;deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Apt-get update Apt-get upgrade&lt;/p&gt;&#xA;&lt;h3 id=&#34;2配置pip源&#34;&gt;2.配置PIP源&#xA;&lt;/h3&gt;&lt;p&gt;Mkdir /root/.pip&lt;/p&gt;&#xA;&lt;p&gt;Vi /root/.pip/pip.conf&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[global]&#xA;timeout = 60&#xA;index-url = http://pypi.douban.com/simple&#xA;trusted-host = pypi.douban.com&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;3下载devstack代码&#34;&gt;3.下载devstack代码&#xA;&lt;/h3&gt;&lt;p&gt;本次部署使用的openstack是newton版本&lt;/p&gt;&#xA;&lt;p&gt;git clone &lt;a class=&#34;link&#34; href=&#34;https://git.openstack.org/openstack-dev/devstack&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;https://git.openstack.org/openstack-dev/devstack&lt;/a&gt; -b stable/newton (网络慢的话可以考虑本机下载后SCP到服务器上)&lt;/p&gt;&#xA;&lt;h3 id=&#34;4配置devstack部署安装相关环境&#34;&gt;4.配置devstack部署安装相关环境&#xA;&lt;/h3&gt;&lt;p&gt;安装python-pip Apt-get install python-pip&lt;/p&gt;&#xA;&lt;p&gt;创建stack用户 Devstack/tools/create-stack-user.sh 添加权限 Vi /etc/sudoers&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# User privilege specification&#xA;root    ALL=(ALL:ALL) ALL&#xA;stack   ALL=(ALL:ALL) ALL&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Chmod 777 /edv/pts/0&lt;/p&gt;&#xA;&lt;p&gt;Mv devstack /opt/stack/ Chown -R stack:stack /opt/stack/devstack&lt;/p&gt;&#xA;&lt;p&gt;切换到stack用户 Su - stack Cd devstack&lt;/p&gt;&#xA;&lt;h3 id=&#34;5编写配置文件&#34;&gt;5.编写配置文件&#xA;&lt;/h3&gt;&lt;p&gt;Vi local.conf 配置文件可选参数太多，不再列出，下附本次部署的配置文件&lt;/p&gt;&#xA;&lt;p&gt;R730(控制节点)部署文件local.conf:&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[[local|localrc]]&#xA; &#xA;MULTI_HOST=true&#xA; &#xA;# management &amp;amp; api network&#xA;HOST_IP=10.32.19.1&#xA;LOGFILE=/opt/stack/logs/stack.sh.log&#xA; &#xA;# Credentials&#xA;ADMIN_PASSWORD=admin&#xA;MYSQL_PASSWORD=secret&#xA;RABBIT_PASSWORD=secret&#xA;SERVICE_PASSWORD=secret&#xA;SERVICE_TOKEN=abcdefghijklmnopqrstuvwxyz&#xA; &#xA;# enable neutron-ml2-vlan&#xA;disable_service n-net&#xA;enable_service q-svc,q-agt,q-dhcp,q-l3,q-meta,neutron,q-lbaas,q-fwaas&#xA;Q_AGENT=openvswitch&#xA;ENABLE_TENANT_VLANS=True&#xA;TENANT_VLAN_RANGE=3001:4000&#xA;PHYSICAL_NETWORK=eno2&#xA; &#xA;LOG_COLOR=True&#xA;LOGDIR=$DEST/logs&#xA;SCREEN_LOGDIR=$LOGDIR/screen&#xA; &#xA;#network&#xA;FIXED_RANGE=192.168.0.0/24&#xA;NETWORK_GATEWAY=192.168.0.1&#xA;FLOATING_RANGE=10.32.19.0/22&#xA;PUBLIC_NETWORK_GATEWAY=10.32.16.1&#xA;Q_FLOATING_ALLOCATION_POOL=start=10.32.19.3,end=10.32.19.10&#xA; &#xA;# use TryStack git mirror&#xA;GIT_BASE=http://git.trystack.cn&#xA;NOVNC_REPO=http://git.trystack.cn/kanaka/noVNC.git&#xA;SPICE_REPO=http://git.trystack.cn/git/spice/spice-html5.git&#xA; &#xA; &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;R720(计算节点)部署文件local.conf:&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[[local|localrc]]&#xA; &#xA;MULTI_HOST=true&#xA; &#xA;# management &amp;amp; api network&#xA;HOST_IP=10.32.19.2&#xA; &#xA;# Credentials&#xA;ADMIN_PASSWORD=admin&#xA;MYSQL_PASSWORD=secret&#xA;RABBIT_PASSWORD=secret&#xA;SERVICE_PASSWORD=secret&#xA;SERVICE_TOKEN=abcdefghijklmnopqrstuvwxyz&#xA; &#xA;# Service information&#xA;SERVICE_HOST=10.32.19.1&#xA;MYSQL_HOST=$SERVICE_HOST&#xA;RABBIT_HOST=$SERVICE_HOST&#xA;GLANCE_HOSTPORT=$SERVICE_HOST:9292&#xA;Q_HOST=$SERVICE_HOST&#xA;KEYSTONE_AUTH_HOST=$SERVICE_HOST&#xA;KEYSTONE_SERVICE_HOST=$SERVICE_HOST&#xA; &#xA;ENABLED_SERVICES=n-cpu,q-agt,neutron,n-api-meta,cinder,c-vol,placement-client&#xA;Q_AGENT=openvswitch&#xA;ENABLE_TENANT_VLANS=True&#xA;TENANT_VLAN_RANGE=3001:4000&#xA;PHYSICAL_NETWORK=default&#xA; &#xA;# vnc config&#xA;NOVA_VNC_ENABLED=True&#xA;NOVNCPROXY_URL=&amp;#34;http://$SERVICE_HOST:6080/vnc_auto.html&amp;#34;&#xA;VNCSERVER_LISTEN=$HOST_IP&#xA;VNCSERVER_PROXYCLIENT_ADDRESS=$VNCSERVER_LISTEN&#xA; &#xA;LOG_COLOR=True&#xA;LOGDIR=$DEST/logs&#xA;SCREEN_LOGDIR=$LOGDIR/screen&#xA; &#xA;# use TryStack git mirror&#xA;GIT_BASE=http://git.trystack.cn&#xA;NOVNC_REPO=http://git.trystack.cn/kanaka/noVNC.git&#xA;SPICE_REPO=http://git.trystack.cn/git/spice/spice-html5.git&#xA; &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;R710(计算节点)部署文件local.conf:&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[[local|localrc]]&#xA; &#xA;MULTI_HOST=true&#xA; &#xA;# management &amp;amp; api network&#xA;HOST_IP=10.32.19.3&#xA; &#xA;# Credentials&#xA;ADMIN_PASSWORD=admin&#xA;MYSQL_PASSWORD=secret&#xA;RABBIT_PASSWORD=secret&#xA;SERVICE_PASSWORD=secret&#xA;SERVICE_TOKEN=abcdefghijklmnopqrstuvwxyz&#xA; &#xA;# Service information&#xA;SERVICE_HOST=10.32.19.1&#xA;MYSQL_HOST=$SERVICE_HOST&#xA;RABBIT_HOST=$SERVICE_HOST&#xA;GLANCE_HOSTPORT=$SERVICE_HOST:9292&#xA;Q_HOST=$SERVICE_HOST&#xA;KEYSTONE_AUTH_HOST=$SERVICE_HOST&#xA;KEYSTONE_SERVICE_HOST=$SERVICE_HOST&#xA; &#xA;ENABLED_SERVICES=n-cpu,q-agt,neutron,n-api-meta,cinder,c-vol,placement-client&#xA;Q_AGENT=openvswitch&#xA;ENABLE_TENANT_VLANS=True&#xA;TENANT_VLAN_RANGE=3001:4000&#xA;PHYSICAL_NETWORK=default&#xA; &#xA;# vnc config&#xA;NOVA_VNC_ENABLED=True&#xA;NOVNCPROXY_URL=&amp;#34;http://$SERVICE_HOST:6080/vnc_auto.html&amp;#34;&#xA;VNCSERVER_LISTEN=$HOST_IP&#xA;VNCSERVER_PROXYCLIENT_ADDRESS=$VNCSERVER_LISTEN&#xA; &#xA;LOG_COLOR=True&#xA;LOGDIR=$DEST/logs&#xA;SCREEN_LOGDIR=$LOGDIR/screen&#xA; &#xA;# use TryStack git mirror&#xA;GIT_BASE=http://git.trystack.cn&#xA;NOVNC_REPO=http://git.trystack.cn/kanaka/noVNC.git&#xA;SPICE_REPO=http://git.trystack.cn/git/spice/spice-html5.git&#xA; &#xA; &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;3部署过程&#34;&gt;3.部署过程&#xA;&lt;/h2&gt;&lt;p&gt;首先在R730控制节点运行 ./stack.sh 等待部署完成，差不多2钟头内就会完成&lt;/p&gt;&#xA;&lt;p&gt;然后把外网网卡eno2绑定到外部网络网桥br-ex上，把eno2的ip交给br-ex网桥。接着把/etc/neutron/l3_agent.ini中external_network_bridge选项改为br-ex。 同时，修改/etc/neutron/plugins/ml2/ml2_conf.ini文件，把br-ex对应的项目选择正确，同时记录flat_networks的名称，与下面的外网网桥对应，此名称即为horizon中FLAT网络类型的物理网络名称，一定不可填错。最后通过screen -x stack进入neutron服务，重启之，即可。&lt;/p&gt;&#xA;&lt;p&gt;然后在R710和R720计算节点运行 ./stack.sh 既可（计算节点部署时间在30分钟以内，可随时按上述操作步骤新增计算节点）&lt;/p&gt;&#xA;&lt;h1 id=&#34;4其他杂项&#34;&gt;4.其他杂项&#xA;&lt;/h1&gt;&lt;h2 id=&#34;1部署过程中出错的解决方案&#34;&gt;1.部署过程中出错的解决方案&#xA;&lt;/h2&gt;&lt;p&gt;首先查看错误类型，常见的错误是网络问题导致下载失败 然后运行 ./unstack.sh 解除安装&lt;/p&gt;&#xA;&lt;p&gt;再运行 ./clean.sh 清理环境&lt;/p&gt;&#xA;&lt;p&gt;然后重试安装，如果还是出BUG的话，删除/opt/stack/目录，删除stack用户，重新git clone一个devstack包，创建stack用户进行安装(记得查看python-pip有无安装，没有安装一定要先安装好)&lt;/p&gt;&#xA;&lt;h2 id=&#34;2更改devstack部署配置localconf&#34;&gt;2.更改devstack部署配置local.conf&#xA;&lt;/h2&gt;&lt;p&gt;直接./unstack.sh然后./stack.sh重新部署既可，速度很快，10分钟内就会重新部署完成&lt;/p&gt;&#xA;&lt;h2 id=&#34;3重启服务器导致所有服务全部宕机&#34;&gt;3.重启服务器导致所有服务全部宕机&#xA;&lt;/h2&gt;&lt;p&gt;直接./unstack.sh然后./stack.sh重新部署既可，速度很快，10分钟内就会重新部署完成&lt;/p&gt;&#xA;&lt;h2 id=&#34;4调试openstack各模块参数后重启服务&#34;&gt;4.调试openstack各模块参数后重启服务&#xA;&lt;/h2&gt;&lt;p&gt;使用screen重启服务，切换到stack用户 运行 screen - x stack（或查找screen编号） 通过ctrl+a+p  ctrl+a+n 切换openstack服务 通过ctrl+c 中断服务，然后在对应的窗口按 ↑ 回车 重启服务&lt;/p&gt;&#xA;&lt;h2 id=&#34;5使用不了openstack命令api&#34;&gt;5.使用不了openstack命令API&#xA;&lt;/h2&gt;&lt;p&gt;首先source openrc admin admin&lt;/p&gt;&#xA;&lt;h2 id=&#34;6希望指定由具体哪台服务器创建虚拟机&#34;&gt;6.希望指定由具体哪台服务器创建虚拟机&#xA;&lt;/h2&gt;&lt;p&gt;创建Zone和Aggreate（以R730为例） Source openrc admin admin Nova aggregate-create 3 3 把对应的服务器分配进zone里 Nova aggregate-add-host 3 R730 查看 zone信息 Nova service-list 如上方法吧R710和R720分进不同zone&lt;/p&gt;&#xA;&lt;p&gt;再进入horizon创建虚拟机界面，就会有域选择 &lt;img src=&#34;images/4.png&#34; alt=&#34;&#34; /&gt;&#xA; 选择1就从710创建，选择2从720创建，选择3从730创建。&lt;/p&gt;&#xA;&lt;h2 id=&#34;7解决devstack部署openstack默认配额问题&#34;&gt;7.解决devstack部署openstack默认配额问题&#xA;&lt;/h2&gt;&lt;p&gt;可直接修改/etc/nova/nova.conf配置文件中的默认选择（如 quota_instances=10），然后重启nova服务 也可以直接修改 source openrc admin admin 查看租户配额 Nova quota-defaults &amp;ndash;tenant 租户名 改变租户配额(举例改变实例数量) Nova quota-update &amp;ndash;instance 999 租户名&lt;/p&gt;</description>
        </item></channel>
</rss>
