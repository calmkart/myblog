<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Sso on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/sso/</link>
        <description>Recent content in Sso on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Fri, 28 Sep 2018 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/sso/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>Django sso server(一个用户友好的的单点登录系统)</title>
            <link>http://localhost:1313/posts/2018/09/2018-09-28-django-sso-server%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E5%8F%8B%E5%A5%BD%E7%9A%84%E7%9A%84%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E7%B3%BB%E7%BB%9F/</link>
            <pubDate>Fri, 28 Sep 2018 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2018/09/2018-09-28-django-sso-server%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E5%8F%8B%E5%A5%BD%E7%9A%84%E7%9A%84%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E7%B3%BB%E7%BB%9F/</guid>
            <description>&lt;p&gt;最近写了一个单点登录系统,这里做一些总结.&lt;/p&gt;&#xA;&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/09/5C45207A-AF09-475D-ACD6-E732CFE1596D.png&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/5C45207A-AF09-475D-ACD6-E732CFE1596D.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt; github地址:(欢迎来star一发^_^) &lt;a class=&#34;link&#34; href=&#34;https://github.com/calmkart/Django-sso-server&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;https://github.com/calmkart/Django-sso-server&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h3 id=&#34;1流程原理&#34;&gt;1.流程原理&#xA;&lt;/h3&gt;&lt;h4 id=&#34;1系统管理流程&#34;&gt;&amp;lt;1&amp;gt;.系统管理流程&#xA;&lt;/h4&gt;&lt;p&gt;管理员在初始化系统时，填写ldap相关设置以及管理员账号相关设置，之后管理员账号可以在管理员后台调整相关配置 其中: a.系统初始化时将自动生成rsa公私钥,系统中所有涉及的密码,都会经过aes加密存放在数据库中,包括rsa私钥也会经过aes加密存放 b.在取用密码时将调用aes解密,加密的salt写在了common/crypto.py中,也可以自己替换&lt;/p&gt;&#xA;&lt;h4 id=&#34;2用户流程&#34;&gt;&amp;lt;2&amp;gt;.用户流程&#xA;&lt;/h4&gt;&lt;p&gt;用户登录sso系统，验证ldap账号成功后，将用户信息以&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;now = time.time()&#xA;user_info = &amp;#34;{0}|||||{1}&amp;#34;.format(ldap_username, now)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的形式,通过rsa公钥加密写入cookie中，key为sso_user&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;response.set_cookie(&amp;#39;sso_user&amp;#39;, rsa.crypto(&#xA;                public_key, user_info), domain=options.objects.all()[0].cookie_domain)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其他需要接入sso系统的子系统可以通过sso系统的api，来判断用户是否可以登录&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;url:      /api/auth&#xA;method:   POST&#xA;post_json_data:  {&amp;#34;sso_user&amp;#34;:cookie}&#xA;return:     {&amp;#34;status&amp;#34;:True/False, &amp;#34;msg&amp;#34;:username}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;本sso系统已提供了相关装饰器，可在管理后台-添加站点的帮助栏查看&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;import requests&#xA;&#xA;def auth_login(func):&#xA;&amp;#39;&amp;#39;&amp;#39;&#xA;装饰器,用于需要登录的views functions,将读取cookie并调用sso的api获取username&#xA;&#xA;也可手动编写相关装饰器&#xA;sso系统的登录鉴权api为&amp;#34;http://sso域名/api/auth&amp;#34;(如&amp;#34;http://sso.calmkart.com/api/auth&amp;#34;)&#xA;用POST方法以json形式将sso_cookie传给上述api,&#xA;返回{&amp;#34;status&amp;#34;:True, &amp;#34;msg&amp;#34;:{username}}则登录成功&#xA;否则{&amp;#34;status&amp;#34;:False, &amp;#34;msg&amp;#34;:{exception}}则登录失败&#xA;&#xA;&amp;#39;&amp;#39;&amp;#39;&#xA;    def _auth(request):&#xA;        cookie = request.COOKIES.get(&amp;#34;sso_user&amp;#34;, &amp;#34;&amp;#34;)&#xA;        if cookie==&amp;#34;&amp;#34;:&#xA;            return HttpResponseRedirect(&amp;#34;{http://sso站域名/}&amp;#34;)&#xA;        r = request.post(&amp;#34;{http://sso站域名/api/auth}&amp;#34;,data={&amp;#34;sso_cookie&amp;#34;:cookie})&#xA;        if r.json()[&amp;#34;status&amp;#34;]==False:&#xA;            return HttpResponseRedirect(&amp;#34;{http://sso站域名}&amp;#34;)&#xA;        else:&#xA;            username = r.json()[&amp;#34;msg&amp;#34;]&#xA;            if username == &amp;#34;&amp;#34; or username == &amp;#34;error&amp;#34;:&#xA;                return HttpResponseRedirect(&amp;#34;{http://sso站域名/}&amp;#34;)&#xA;            else:&#xA;                return func(request, username)&#xA;    return _auth&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;用户拥有cookie后登陆系统，系统将解cookie，并获取当前时间，若时间不超过最大时间，则返回username&lt;/p&gt;&#xA;&lt;h4 id=&#34;3企业扫码登陆流程&#34;&gt;&amp;lt;3&amp;gt;.企业扫码登陆流程&#xA;&lt;/h4&gt;&lt;p&gt;在管理后台配置企业微信扫码登陆相关参数，通过企业微信相关js api，生成二维码，用户扫码后，企业微信后台将用户请求重定向到/api/wxlogin  (method:get)上，并加上携带有用户username信息的code参数，成功则写cookie。&lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;h3 id=&#34;2common相关模块原理&#34;&gt;2.common相关模块原理&#xA;&lt;/h3&gt;&lt;p&gt;参见本blog其他博文&lt;/p&gt;&#xA;&lt;h4 id=&#34;1关于django的图片验证码&#34;&gt;&amp;lt;1&amp;gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/?p=332&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;关于django的图片验证码&lt;/a&gt;&#xA;&lt;/h4&gt;&lt;h4 id=&#34;2关于python操作ldap&#34;&gt;&amp;lt;2&amp;gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/?p=355&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;关于python操作ldap&lt;/a&gt;&#xA;&lt;/h4&gt;&lt;h4 id=&#34;3关于python操作rsaaes加解密&#34;&gt;&amp;lt;3&amp;gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/?p=353&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;关于python操作rsa,aes加解密&lt;/a&gt;&#xA;&lt;/h4&gt;</description>
        </item></channel>
</rss>
