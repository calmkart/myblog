<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>验证码 on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/</link>
        <description>Recent content in 验证码 on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Tue, 18 Sep 2018 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>django生成图片验证码</title>
            <link>http://localhost:1313/posts/2018/09/2018-09-18-django%E7%94%9F%E6%88%90%E7%99%BB%E5%BD%95%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81/</link>
            <pubDate>Tue, 18 Sep 2018 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2018/09/2018-09-18-django%E7%94%9F%E6%88%90%E7%99%BB%E5%BD%95%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81/</guid>
            <description>&lt;p&gt;最近在做一个好玩的通用django单点登录系统，登录系统少不了验证码，参考了一下别人的做法和开源项目，总结一下。&lt;/p&gt;&#xA;&lt;p&gt;结果如下：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;images/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_837b19bb-98df-4c26-afae-6678c91ff47a.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;主要思路流程是，后端根据随机码绘图，然后做混淆(我这里几乎没做模糊之类的混淆)，最后将随机验证码写进后端session里，前端获取图像后，提交时与session里的验证码做比较。流程还是比较简单的，大致代码如下。&lt;/p&gt;&#xA;&lt;p&gt;1.captcha_handle.py&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;captcha_handle.py&#xA;#用于生成随机字符串以及生成验证码图片&#xA;&#xA;# -*- coding:utf-8 -*-&#xA;import random,string&#xA;from PIL import Image,ImageDraw,ImageFont,ImageFilter&#xA;&#xA;#生成随机字符串&#xA;def _getRandomChar():&#xA;    #string模块包含各种字符串，以下为小写字母加数字&#xA;    ran = string.ascii_lowercase+string.digits&#xA;    char = &amp;#39;&amp;#39;&#xA;    for i in range(4):&#xA;        char += random.choice(ran)&#xA;    return char&#xA;&#xA;#返回一个随机的RGB颜色&#xA;def _getRandomColor():&#xA;    return (random.randint(50,150),random.randint(50,150),random.randint(50,150))&#xA;&#xA;def create_captcha():&#xA;&#xA;    #创建图片，模式，大小，背景色&#xA;    img = Image.new(&amp;#39;RGB&amp;#39;, (120,30), (255,255,255))&#xA;    #创建画布&#xA;    draw = ImageDraw.Draw(img)&#xA;    #设置字体&#xA;    font = ImageFont.truetype(&amp;#39;Arial.ttf&amp;#39;, 25)&#xA;&#xA;    code = _getRandomChar()&#xA;    #将生成的字符画在画布上&#xA;    for t in range(4):&#xA;        draw.text((30*t+5,0),code[t],_getRandomColor(),font)&#xA;&#xA;    #生成干扰点&#xA;    for _ in range(random.randint(0,50)):&#xA;        #位置，颜色&#xA;        draw.point((random.randint(0, 120), random.randint(0, 30)),fill=_getRandomColor())&#xA;&#xA;    #使用模糊滤镜使图片模糊&#xA;    # img = img.filter(ImageFilter.BLUR)&#xA;    #保存&#xA;    #img.save(&amp;#39;&amp;#39;.join(code)+&amp;#39;.jpg&amp;#39;,&amp;#39;jpeg&amp;#39;)&#xA;    return img,code&#xA;&#xA;if __name__ == &amp;#39;__main__&amp;#39;:&#xA;    create_code()&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;2.views.py&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;views.py&#xA;#视图，生成验证码图片和code，返回图片，code存进session&#xA;class get_captcha(View):&#xA;&#xA;    def get(self, request):&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        生成验证码图片和验证码code,返回验证码图片,并以形式将验证码存放在session里&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        try:&#xA;            f = BytesIO()&#xA;            img, code = create_captcha()&#xA;            request.session[&amp;#34;captcha&amp;#34;] = code&#xA;            img.save(f,&amp;#39;PNG&amp;#39;)&#xA;            return HttpResponse(f.getvalue())&#xA;        except Exception as e:&#xA;            log().error(str(e))&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;3.login.html&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;{# html #}&#xA;&amp;lt;div class=&amp;#34;col-xs-4&amp;#34;&amp;gt;&#xA;    &amp;lt;img id=&amp;#34;captcha_img&amp;#34; src=&amp;#34;{% url &amp;#39;get_captcha&amp;#39; %}&amp;#34; onclick=&amp;#34;refresh_captcha()&amp;#34; style=&amp;#34;margin-top: 28px;&amp;#34;&amp;gt;&#xA;    &amp;lt;p class=&amp;#34;help-block&amp;#34; onclick=&amp;#34;refresh_captcha()&amp;#34;&amp;gt;&#xA;    看不清楚?换一张!&#xA;    &amp;lt;/p&amp;gt;&#xA;&amp;lt;/div&amp;gt;&#xA;&#xA;{# js #}&#xA;&amp;lt;script&amp;gt;&#xA;    //刷新验证码&#xA;    function refresh_captcha() {&#xA;        $(&amp;#34;#captcha_img&amp;#34;).attr(&amp;#34;src&amp;#34;,$(&amp;#34;#captcha_img&amp;#34;)[0].src + &amp;#39;?&amp;#39;);&#xA;    };&#xA;&amp;lt;/script&amp;gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;4.url.py&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;url(r&amp;#39;^get_captcha/$&amp;#39;,cas_views.get_captcha.as_view(), name=&amp;#34;get_captcha&amp;#34;),&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;5.views.py&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#校验验证码是否正确&#xA;if request.session[&amp;#34;captcha&amp;#34;].lower() != captcha.lower():&#xA;    return JsonResponse({&amp;#34;status&amp;#34;:False, &amp;#34;msg&amp;#34;:&amp;#34;验证码错误!&amp;#34;})&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;一些代码是参考网络上其他开源代码，不过其实也挺简单的，熟悉request.session就差不多了。做个记录。&lt;/p&gt;</description>
        </item></channel>
</rss>
