<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Bash on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/bash/</link>
        <description>Recent content in Bash on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Wed, 13 Sep 2017 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/bash/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>扩展并修改bash源码使支持rsyslog且增加审计条目</title>
            <link>http://localhost:1313/posts/2017/09/2017-09-13-%E6%89%A9%E5%B1%95%E5%B9%B6%E4%BF%AE%E6%94%B9bash%E6%BA%90%E7%A0%81%E4%BD%BF%E6%94%AF%E6%8C%81rsyslog%E4%B8%94%E5%A2%9E%E5%8A%A0%E5%AE%A1%E8%AE%A1%E6%9D%A1%E7%9B%AE/</link>
            <pubDate>Wed, 13 Sep 2017 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2017/09/2017-09-13-%E6%89%A9%E5%B1%95%E5%B9%B6%E4%BF%AE%E6%94%B9bash%E6%BA%90%E7%A0%81%E4%BD%BF%E6%94%AF%E6%8C%81rsyslog%E4%B8%94%E5%A2%9E%E5%8A%A0%E5%AE%A1%E8%AE%A1%E6%9D%A1%E7%9B%AE/</guid>
            <description>&lt;p&gt;最终效果： log记录: /var/log/messages&lt;/p&gt;&#xA;&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2017/09/1.png&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/1.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;history记录: history&lt;/p&gt;&#xA;&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2017/09/2-1.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/2-1.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;首先去gnu下载最新版的bash源码，本次采用的是bash-4.4版本&lt;/p&gt;&#xA;&lt;p&gt;编辑config-top.h文件，主要关注以下两点: 一.103行，取消&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#define SSH_SOURCE_BASHRC&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的注释 二.116行，取消&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#define SYSLOG_HISTORY&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的注释&lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt;然后编辑bashhist.c源码文件，主要关注750行-&amp;gt;800行。 未经修改的原文件：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;void&#xA;bash_syslog_history (line)&#xA;     const char *line;&#xA;{&#xA;  char trunc[SYSLOG_MAXLEN];&#xA;  static int first = 1;&#xA;&#xA;  if (first)&#xA;    {&#xA;      openlog (shell_name, OPENLOG_OPTS, SYSLOG_FACILITY);&#xA;      first = 0;&#xA;    }&#xA;&#xA;  if (strlen(line) &amp;lt; SYSLOG_MAXLEN)&#xA;    syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY: PID=%d UID=%d %s&amp;#34;, getpid(), current_user.uid, line);&#xA;  else&#xA;    {&#xA;      strncpy (trunc, line, SYSLOG_MAXLEN);&#xA;      trunc[SYSLOG_MAXLEN - 1] = &amp;#39;\0&amp;#39;;&#xA;      syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY (TRUNCATED): PID=%d UID=%d %s&amp;#34;, getpid(), current_user.uid, trunc);&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里主要就是用来修改syslog服务的相关记录项，可以增删功能。 修改后的代码：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;bash_syslog_history (line)&#xA;     const char *line;&#xA;{&#xA;  char trunc[SYSLOG_MAXLEN];&#xA;  static int first = 1;&#xA;  FILE *fp;&#xA;  char buffer[LEN_p];&#xA;  fp=popen(&amp;#34;echo \&amp;#34;[`who am i 2&amp;gt;/dev/null| awk &amp;#39;{print $NF}&amp;#39;|sed -e &amp;#39;s/ [()]//g&amp;#39;|sed &amp;#39;s/(//g&amp;#39;|sed &amp;#39;s/)//g&amp;#39;`]\&amp;#34;&amp;#34;,&amp;#34;r&amp;#34;);&#xA;  fgets(buffer,sizeof(buffer),fp);&#xA;  int ii = LEN_p-1;&#xA;  while(ii&amp;gt;=0 &amp;amp;&amp;amp; buffer[ii]==&amp;#39; &amp;#39;)&#xA;  ii--;&#xA;  buffer[ii] = &amp;#39;\0&amp;#39;;&#xA;  char buffer_test[LEN_p];&#xA;  int iii = 0;&#xA;  int jjj = 0;&#xA;  while(buffer[iii]!=&amp;#39;\0&amp;#39;){&#xA;   if(buffer[iii]&amp;lt;32)&#xA;     iii++;&#xA;    else&#xA;     buffer_test[jjj++]=buffer[iii++];&#xA;&#xA;  }&#xA;  buffer_test[jjj]=&amp;#39;\0&amp;#39;;&#xA;  //const char *buffer_test;&#xA;  //buffer_test = buffer;&#xA;  pclose(fp);&#xA;  //buffer_test = getenv(&amp;#34;NAME_OF_KEY&amp;#34;);&#xA;  if (first)&#xA;    {&#xA;      openlog (shell_name, OPENLOG_OPTS, SYSLOG_FACILITY);&#xA;      first = 0;&#xA;    }&#xA;&#xA;  if (strlen(line) &amp;lt; SYSLOG_MAXLEN)&#xA;    syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY: PID=%d UID=%d User=%s KEY=%s CMD=%s&amp;#34;, getpid(), current_user.uid, current_user.user_name, buffer_test,line);&#xA;  else&#xA;    {&#xA;      strncpy (trunc, line, SYSLOG_MAXLEN);&#xA;      trunc[SYSLOG_MAXLEN - 1] = &amp;#39;\0&amp;#39;;&#xA;      syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY (TRUNCATED): PID=%d UID=%d User=%s KEY=%s CMD=%s&amp;#34;, getpid(), current_user.uid, current_user.user_name, buffer_test,trunc);&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里既是通过修改源码的方法添加了审计username和IP的功能，如需要加入其他任何功能直接在这里写C代码就可以了。 然后，有唯一一个需要注意的要点，rsyslog处理所有ascii&amp;lt;32的特殊字符都会显示#012无法识别，所以无论用rsyslog记录什么，都需要把ascii&amp;lt;32的特殊字符删除掉 然后编译，替换/bin/bash不再多说&lt;/p&gt;&#xA;&lt;p&gt;最后，可以编辑/etc/profile，修改环境变量，添加如下三行常用配置：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;export HISTTIMEFORMAT=&amp;#34;[%Y-%m-%d %H:%M:%S] [`who am i 2&amp;gt;/dev/null| awk &amp;#39;{print $NF}&amp;#39;|sed -e &amp;#39;s/[    ()]//g&amp;#39;`] &amp;#34;&#xA;export HISTSIZE=&amp;#34;999999&amp;#34;&#xA;readonly PROMPT_COMMAND=&amp;#34;history -a&amp;#34;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;第一行定义history格式 第二行第一history最大存储 第三行让所有用户操作都能即时写入history中，而不是退出session时再写入(如果同时又几个用户登录，可能导致history事件错乱)&lt;/p&gt;</description>
        </item></channel>
</rss>
