<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>测试 on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/%E6%B5%8B%E8%AF%95/</link>
        <description>Recent content in 测试 on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Thu, 25 Jan 2018 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/%E6%B5%8B%E8%AF%95/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>部署sentry捕获项目错误信息</title>
            <link>http://localhost:1313/posts/2018/01/2018-01-25-%E9%83%A8%E7%BD%B2sentry%E6%8D%95%E8%8E%B7%E9%A1%B9%E7%9B%AE%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF/</link>
            <pubDate>Thu, 25 Jan 2018 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2018/01/2018-01-25-%E9%83%A8%E7%BD%B2sentry%E6%8D%95%E8%8E%B7%E9%A1%B9%E7%9B%AE%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF/</guid>
            <description>&lt;p&gt;sentry是一款专用于捕捉项目错误信息的分布式开源软件，可以轻松的捕捉到不同项目的错误信息并汇总，方便实时查看上下文排错以及报警等。 最终效果图如下： &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/sentry1.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/sentry1.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt; &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/sentry2.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/sentry2.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt; &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/sentry3.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/sentry3.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;首先，sentry和ELK的不同之处在于，虽然都基于LOG的追踪，但sentry主要关注错误的捕获和上下文重出现报警，而ELK主要关注日志的处理。&lt;/p&gt;&#xA;&lt;h4 id=&#34;1sentry的部署&#34;&gt;1.sentry的部署&#xA;&lt;/h4&gt;&lt;p&gt;官方文档 &lt;a class=&#34;link&#34; href=&#34;https://docs.sentry.io/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;https://docs.sentry.io/&lt;/a&gt; 大致来说，主要分为如下几个步骤：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#安装postgresql&#xA;apt-get install postgresql&#xA;apt-get install postgresql-contrib&#xA;&#xA;#安装celery，redis&#xA;pip install celery&#xA;apt-get install redis-server&#xA;&#xA;#安装需要的包&#xA;apt-get install python-setuptools python-dev libxslt1-dev gcc libffi-dev libjpeg-dev libxml2-dev libxslt-dev libyaml-dev libpq-dev&#xA;&#xA;#安装sentry，推荐使用venv环境&#xA;pip install sentry&#xA;&#xA;#生成配置文件,也可制定配置文件路径&#xA;#sentry init /etc/sentry &#xA;sentry init&#xA;&#xA;#配置数据库&#xA;sudo -u postgres psql&#xA;create user admin with password &amp;#39;admin&amp;#39;;&#xA;create database sentry owner admin;&#xA;grant all privileges on database sentry to admin;&#xA;&#xA;#提升该用户superuser权限&#xA;alter role admin superuser;&#xA;&#xA;#修改sentry的相关配置，配置数据库相关设置，与上数据库设置相符合&#xA;vi /root/.sentry/sentry.conf.py&#xA;&#xA;#初始化数据库，可以制定配置文件路径也可默认&#xA;#SENTRY_CONF=/etc/sentry sentry upgrade&#xA;sentry upgrade&#xA;&#xA;#添加celery用root用户跑的环境变量&#xA;export C_FORCE_ROOT=&amp;#34;true&amp;#34;&#xA;&#xA;#最后创建用户&#xA;sentry createuser&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在upgrade过程中可能会出现错误，根据具体错误类型判断如何排错，然后删掉数据库后重建数据库，再upgrade即可，一般都是数据库权限问题。&lt;/p&gt;&#xA;&lt;h4 id=&#34;2sentry的使用&#34;&gt;2.sentry的使用&#xA;&lt;/h4&gt;&lt;p&gt;主要要跑3个任务，如下&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#SENTRY_CONF=/etc/sentry sentry run web&#xA;sentry run web&#xA;#SENTRY_CONF=/etc/sentry sentry run worker&#xA;sentry run worker&#xA;#SENTRY_CONF=/etc/sentry sentry run cron&#xA;sentry run cron&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我在测试环境中是用gosuv来跑的，效果如图： &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/gosuv.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/gosuv.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt; 其中要注意的是，如果任务直接用&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;sentry run web&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这样来跑的话，会找不到配置文件，所以需要配置成如下结构： &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/gosuv2.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/gosuv2.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt; 同时，还跑了一个用于测试监控捕获错误的flask程序，其中用到了venv，所以gosuv也好，supervisor也好，都需要做成如下设置&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#找到venv的虚拟环境，用虚拟环境的bin运行项目&#xA;./venv/bin/python runserver.py&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;3sentry-web的应用和配置&#34;&gt;3.sentry web的应用和配置&#xA;&lt;/h4&gt;&lt;p&gt;默认起的sentry web占用的是9000端口，也可以自己修改端口号。 登陆ip:9000，输入刚才设置的邮箱账号密码进入sentry，填一下相关设置 点击右上角new project,选择你需要监控错误的对象，这里选择flask，然后会出现 &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/sentry4.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/sentry4.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt; 主要关注这个DSN key，在已有的项目可以在这里查看 &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/sentry5.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/sentry5.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;然后首先在客户端安装maven[flask]&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;pip install raven[flask]&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;最后在flask程序里添加如下&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#__init__.py里设置app，故添加如下&#xA;from raven.contrib.flask import Sentry&#xA;sentry = Sentry(app, &#xA; dsn=&amp;#39;http://f1010071f12c47768dc6b5a4700d9c2e:5643252bcc70471eb5232a632f3ea133@10.32.80.118:9000//2&amp;#39;&#xA; )&#xA;&#xA;#views.py里添加如下&#xA;from flask_security import login_required, current_user&#xA;from hello import app&#xA;from hello import sentry&#xA;&#xA;@app.route(&amp;#39;/error&amp;#39;)&#xA;def error():&#xA;    try:&#xA;        1/0&#xA;    except ZeroDivisionError:&#xA;        sentry.captureException()&#xA;        return &amp;#39;error&amp;#39;&#xA;&#xA;@app.route(&amp;#39;/raise&amp;#39;)&#xA;def auto_raise():&#xA;    raise IndexError&#xA;&#xA;@app.route(&amp;#39;/log&amp;#39;)&#xA;def log():&#xA;    sentry.captureMessage(&amp;#39;hello, world!&amp;#39;)&#xA;    return &amp;#39;logging&amp;#39;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;类似如图结构： &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/01/flask.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/flask.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;然后就可以在sentry中即时捕捉到对应的错误和logging了&lt;/p&gt;</description>
        </item></channel>
</rss>
