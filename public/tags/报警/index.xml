<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>报警 on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/%E6%8A%A5%E8%AD%A6/</link>
        <description>Recent content in 报警 on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Wed, 23 Aug 2017 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/%E6%8A%A5%E8%AD%A6/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>zabbix报警收敛</title>
            <link>http://localhost:1313/posts/2017/08/2017-08-23-zabbix%E6%8A%A5%E8%AD%A6%E6%94%B6%E6%95%9B/</link>
            <pubDate>Wed, 23 Aug 2017 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2017/08/2017-08-23-zabbix%E6%8A%A5%E8%AD%A6%E6%94%B6%E6%95%9B/</guid>
            <description>&lt;p&gt;因zabbix可能同一段时间报警过多，接受消息时如果不做收敛可能出错也不容易审查，所以需要一个报警收敛机制。&lt;/p&gt;&#xA;&lt;p&gt;实验环境分为server端与client端： server端模拟收敛程序通过TCP SOCKET连接接受zabbix报警，做收敛处理并发送； client端模拟zabbix报警程序，通过TCP SOCKET连接发送模拟的zabbix报警给server;&lt;/p&gt;&#xA;&lt;p&gt;server端程序如下：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# -*- coding:utf-8 -*-&#xA;from threading import Timer&#xA;import urllib2&#xA;import socket&#xA;import threading&#xA;import re&#xA;&#xA;#event_list为收敛类型数目列表&#xA;#ip_list为IP收敛字典列表&#xA;#summary为收敛类型说明列表&#xA;#keyw为正则匹配元素&#xA;&#xA;class convergence(object):&#xA;&#x9;event_list = [0,0,0,0]&#xA;&#x9;summary = [&amp;#39;获取uptime时间失败&amp;#39;,&amp;#39;SNMP_cant_respond_for_5minutes错误&amp;#39;,&amp;#39;OK错误&amp;#39;,&amp;#39;流量速率异常错误&amp;#39;]&#xA;&#x9;ip_list = [{},{},{},{}]&#xA;&#x9;keyw = [&amp;#39;获取uptime时间失败&amp;#39;,&amp;#39;SNMPcan\&amp;#39;trespondfor5minutes&amp;#39;,&amp;#39;ok&amp;#39;,&amp;#39;流量速度异常&amp;#39;]&#xA;&#x9;t = None&#xA;&#x9;&#xA;&#x9;def convergence(self,event):&#xA;&#x9;&#x9;temp = self.keyword(event)&#xA;&#x9;&#x9;ip = self.findip(event)&#xA;&#x9;&#x9;if temp != 0:&#xA;&#x9;&#x9;&#x9;#做报警IP收敛&#xA;&#x9;&#x9;&#x9;if self.ip_list[temp-1].has_key(ip):&#xA;&#x9;&#x9;&#x9;&#x9;self.ip_list[temp-1][ip] = self.ip_list[temp-1][ip]+1&#xA;&#x9;&#x9;&#x9;else:&#xA;&#x9;&#x9;&#x9;&#x9;self.ip_list[temp-1][ip] = 1&#xA;&#x9;&#x9;&#x9;#做报警条目收敛&#xA;&#x9;&#x9;&#x9;self.event_list[temp-1] = self.event_list[temp-1]+1&#xA;&#x9;&#x9;&#x9;if self.t == None:&#xA;&#x9;&#x9;&#x9;&#x9;self.timer(event)&#xA;&#x9;&#x9;&#x9;else:&#xA;&#x9;&#x9;&#x9;&#x9;pass&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;else:&#xA;&#x9;&#x9;&#x9;#按原格式发送&#xA;&#x9;&#x9;&#x9;print event&#xA;&#x9;&#x9;&#x9;pass&#xA;&#xA;&#x9;def send(self,event):&#xA;&#x9;&#x9;print &amp;#39;目前的缓存区为&amp;#39;+str(self.event_list)&#xA;&#x9;&#x9;if max(self.event_list) == 0:&#xA;&#x9;&#x9;&#x9;pass&#xA;&#x9;&#x9;else:&#xA;&#x9;&#x9;&#x9;for i in range(0,len(event_list)):&#xA;&#x9;&#x9;&#x9;&#x9;if self.event_list[i]==0:&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pass&#xA;&#x9;&#x9;&#x9;&#x9;else:#发送收敛后的报警到指定位置&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;content = str(event_list[i]+&amp;#39;次&amp;#39;+self.summary[i]+&amp;#39;(前20秒内)&amp;#39;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;self.event_list[i] = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;self.t = None&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;urllib2.urlopen(&amp;#39;http://www.calmkart.com&amp;#39;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;print content&#xA;&#xA;&#x9;def timer(self,event):#启动定时器&#xA;&#x9;&#x9;self.t = Timer(20,self.send,args=[event])&#xA;&#x9;&#x9;self.t.start()&#xA;&#x9;&#xA;&#x9;def keyword(self,event):&#xA;&#x9;&#x9;for i in range(0,len(self.keyw)):&#xA;&#x9;&#x9;&#x9;if re.search(self.keyw[i],event,flags=re.IGNORECASE) != None:&#xA;&#x9;&#x9;&#x9;&#x9;return i+1&#xA;&#x9;&#x9;return 0&#xA;&#x9;&#xA;&#x9;def findip(self,event):&#xA;&#x9;&#x9;m = re.search(r&amp;#39;(?&amp;lt;![\.\d])(?:\d{1,3}\.){3}\d{1,3}(?![\.\d])&amp;#39;,event)&#xA;&#x9;&#x9;if m is not None:&#xA;&#x9;&#x9;&#x9;ip = m.group()&#xA;&#x9;&#x9;&#x9;return str(ip)&#xA;&#x9;&#x9;return &amp;#39;查不到IP&amp;#39;&#xA;&#xA;test = convergence()&#xA;&#xA;#tcp测试,server端，接收&#xA;host = &amp;#39;0.0.0.0&amp;#39;&#xA;port = 9001&#xA;s = socket.socket()&#xA;s.bind((host,port))&#xA;s.listen(5)&#xA;&#xA;while True:&#xA;&#x9;c,addr = s.accept()&#xA;&#x9;data = c.recv(1024)&#xA;&#x9;test.convergence(data)&#xA;&#x9;&#xA;##udp测试,server端，接收&#xA;#s= socket.socket(socket.AF_INET, socket.SOCK_DGRAM)&#xA;#host = &amp;#39;10.17.16.207&amp;#39;&#xA;#port = 9001&#xA;#s.bind((host,port))&#xA;#&#xA;#while True:&#xA;#&#x9;data,addr = s.recvfrom(2048)&#xA;#&#x9;test.convergence(data)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt;clent端程序如下：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# --- coding:utf-8 ---&#xA;import random&#xA;from multiprocessing.connection import Client&#xA;&#xA;str1 = [&#xA;&#x9;&amp;#39;192.168.0.1SNMP错误&amp;#39;,&#xA;        &amp;#39;192.168.0.2SNMP错误&amp;#39;,&#xA;        &amp;#39;192.168.0.100,OK&amp;#39;,&#xA;        &amp;#39;192.168.0.101,ok&amp;#39;,&#xA;&#x9;&amp;#39;192.168.0.102,流量速率异常&amp;#39;,&#xA;&#x9;&amp;#39;192.168.0.103,流量速率异常&amp;#39;,&#xA;&#x9;&amp;#39;192.168.0.104,获取uptime时间失败&amp;#39;,&#xA;&#x9;&amp;#39;192.168.0.105,获取uptime时间失败&amp;#39;&#xA;] &#xA;address = (&amp;#39;0.0.0.0&amp;#39;,9001)&#xA;&#xA;for i in range(0,1000):&#xA;&#x9;m = str1[random.randrange(0,11)]&#xA;&#x9;conn = Client(address)&#xA;&#x9;conn.send(m)&#xA;&#x9;conn.close&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;主要用到的工具是正则表达式做匹配&lt;/p&gt;&#xA;&lt;p&gt;代码已上传至github,地址 &lt;a class=&#34;link&#34; href=&#34;https://github.com/calmkart/Zabbix_convergence&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;https://github.com/calmkart/Zabbix_convergence&lt;/a&gt;&lt;/p&gt;</description>
        </item></channel>
</rss>
