<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Ldap on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/ldap/</link>
        <description>Recent content in Ldap on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Fri, 28 Sep 2018 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/ldap/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>python操作ldap</title>
            <link>http://localhost:1313/posts/2018/09/2018-09-28-python%E6%93%8D%E4%BD%9Cldap/</link>
            <pubDate>Fri, 28 Sep 2018 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2018/09/2018-09-28-python%E6%93%8D%E4%BD%9Cldap/</guid>
            <description>&lt;p&gt;封装了一个python的ldap常用操作类&lt;/p&gt;&#xA;&lt;p&gt;首先pip装库&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;pip install python-ldap&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后开始代码部分&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# -*- coding:utf-8 -*-&#xA;from __future__ import absolute_import&#xA;&#xA;import binascii&#xA;import hashlib&#xA;from base64 import b64encode&#xA;&#xA;import ldap&#xA;import ldap.modlist as modlist&#xA;&#xA;from common.common import log&#xA;&#xA;class MyLdap():&#xA;     &#xA;    def __init__(self,ldap_host=None,base_dn=None,user=None,password=None):&#xA;        self.base_dn = base_dn&#xA;        self.ldap_host = ldap_host&#xA;        self.user = user&#xA;        self.password = password&#xA;        try:&#xA;            self.ldapconn = ldap.initialize(ldap_host)&#xA;            self.ldapconn.simple_bind(user,password)&#xA;        except ldap.LDAPError,e:&#xA;            log().error(str(e))&#xA;            print e&#xA;&#xA;    @property&#xA;    def status(self):&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        验证初始化ldap账号密码,以及ldap地址是否正确&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        ldap_client = ldap.initialize(self.ldap_host)&#xA;        try:&#xA;            ldap_client.simple_bind_s(self.user, self.password)&#xA;            ldap_client.unbind_s()&#xA;            return {&amp;#34;status&amp;#34;:True}&#xA;        except Exception as e:&#xA;            log().error(str(e))&#xA;            return {&amp;#34;status&amp;#34;:False, &amp;#34;msg&amp;#34;:&amp;#34;ldap初始化管理员账号密码或ldap地址有误,详情:{0}&amp;#34;.format(str(e))}&#xA;&#xA;    def _ldap_search_dn(self,uid=None):&#xA;        obj = self.ldapconn&#xA;        obj.protocal_version = ldap.VERSION3&#xA;        searchScope = ldap.SCOPE_SUBTREE&#xA;        retrieveAttributes = None &#xA;        searchFilter = &amp;#34;cn=&amp;#34; + uid&#xA;        &#xA;        try:&#xA;            ldap_result_id = obj.search(self.base_dn, searchScope, searchFilter, retrieveAttributes)&#xA;            result_type, result_data = obj.result(ldap_result_id, 0)&#xA;            if result_type == ldap.RES_SEARCH_ENTRY:&#xA;                return result_data[0][0]&#xA;            else:&#xA;                return None&#xA;        except ldap.LDAPError, e:&#xA;            log().error(str(e))&#xA;&#xA;    def ldap_get_user(self,uid=None):&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        获取ldap用户详情,失败返None&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        obj = self.ldapconn&#xA;        obj.protocal_version = ldap.VERSION3&#xA;        searchScope = ldap.SCOPE_SUBTREE&#xA;        retrieveAttributes = None &#xA;        searchFilter = &amp;#34;cn=&amp;#34; + uid&#xA;        try:&#xA;            ldap_result_id = obj.search(self.base_dn, searchScope, searchFilter, retrieveAttributes)&#xA;            result_type, result_data = obj.result(ldap_result_id, 0)&#xA;            if result_type == ldap.RES_SEARCH_ENTRY:&#xA;                username = result_data[0][1][&amp;#39;cn&amp;#39;][0]&#xA;                mail = result_data[0][1][&amp;#39;mail&amp;#39;][0]&#xA;                displayName = result_data[0][1][&amp;#39;displayName&amp;#39;][0]&#xA;                sn = result_data[0][1][&amp;#39;sn&amp;#39;][0]&#xA;                result = {&amp;#39;username&amp;#39;:username,&amp;#39;mail&amp;#39;:mail,&amp;#39;displayName&amp;#39;:displayName, &amp;#39;sn&amp;#39;:sn}&#xA;                return result&#xA;            else:&#xA;                return None&#xA;        except ldap.LDAPError, e:&#xA;            log().error(str(e))&#xA;    &#xA;    def ldap_get(self,uid=None,passwd=None):&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        验证ldap账号密码,成功返True,失败返False&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        target_cn = self._ldap_search_dn(uid)&#xA;        if not target_cn:&#xA;            return False   &#xA;        try:&#xA;            client = ldap.initialize(self.ldap_host)&#xA;            client.simple_bind_s(target_cn,passwd)&#xA;            client.unbind_s()&#xA;            return True&#xA;        except ldap.LDAPError,e:&#xA;            log().error(str(e))&#xA;            return False&#xA;&#xA;    &#xA;    def cnupdatepass(self, cn, passwd):&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        更改ldap密码,成功返True,失败返error&#xA;        &amp;#39;&amp;#39;&amp;#39;&#xA;        dn=&amp;#39;cn={0},{1}&amp;#39;.format(cn, self.base_dn)&#xA;        try:&#xA;            result=self.ldapconn.search_s(dn, ldap.SCOPE_SUBTREE, &amp;#39;cn=%s&amp;#39; % cn)&#xA;            oldpass=result[0][1][&amp;#39;userPassword&amp;#39;]&#xA;            oldwifipass=result[0][1][&amp;#39;sambaNTPassword&amp;#39;]&#xA;            newpass=&amp;#39;{MD5}&amp;#39; + b64encode(hashlib.md5(passwd).digest())&#xA;            wifipass=binascii.hexlify(hashlib.new(&amp;#39;md4&amp;#39;, passwd.encode(&amp;#39;utf-16le&amp;#39;)).digest())&#xA;            old={&amp;#39;userPassword&amp;#39;:oldpass,&amp;#39;sambaNTPassword&amp;#39;: oldwifipass}&#xA;            new={&amp;#34;sambaNTPassword&amp;#34;: [wifipass],&amp;#34;userPassword&amp;#34;:[newpass]}&#xA;            mlist = modlist.modifyModlist(old, new)&#xA;            self.ldapconn.modify_s(dn, mlist)&#xA;            return {&amp;#34;status&amp;#34;:True}&#xA;        except ldap.LDAPError as e:&#xA;            log().error(str(e))&#xA;            return {&amp;#34;status&amp;#34;:False, &amp;#34;msg&amp;#34;:&amp;#34;ldap更改密码错误,详情: {0}&amp;#34;.format(str(e))}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;使用时&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;ldap_client = MyLdap(ldap_url, base_dn, admin, password)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;代码注释已经写的很清楚了感觉,不再写详情了,本文做个备忘&lt;/p&gt;</description>
        </item></channel>
</rss>
