<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>运维安全 on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/%E8%BF%90%E7%BB%B4%E5%AE%89%E5%85%A8/</link>
        <description>Recent content in 运维安全 on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Mon, 18 Dec 2017 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/%E8%BF%90%E7%BB%B4%E5%AE%89%E5%85%A8/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>修改salt源码实现jobs.list_jobs加密账号密码</title>
            <link>http://localhost:1313/posts/2017/12/2017-12-18-%E4%BF%AE%E6%94%B9salt%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0jobs-list_jobs%E5%8A%A0%E5%AF%86%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/</link>
            <pubDate>Mon, 18 Dec 2017 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2017/12/2017-12-18-%E4%BF%AE%E6%94%B9salt%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0jobs-list_jobs%E5%8A%A0%E5%AF%86%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/</guid>
            <description>&lt;p&gt;在salt master中为各个minion运行各种命令，当输入命令中显式带有账号密码时，可以在master端通过 salt.runners.jobs.last_run() salt.runners.jobs.list_job() salt.runners.jobs.list_jobs() salt.runners.jobs.list_jobs_filter() 等种种方法查看到账号密码，这样就会有安全风险。 所以，可以通过修改salt源码的方式实现对显示密码的记录加密。最终效果如下图： &lt;img src=&#34;images/zzxg.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;修改方法很简单，首先找到系统中的salt文件夹，本测试机在&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;/usr/lib/python2.7/dist-packages/salt/&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;修改./runners/jobs.py文件&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#添加函数,这里主要是正则匹配，可以匹配更多的pass选项，实现更多的隐藏密码&#xA;import re&#xA;def encry_pass(target):&#xA;    result = re.sub(r&amp;#34;(?&amp;lt;=--password )\w+&amp;#34;, &amp;#34;*&amp;#34;, target)&#xA;    return result&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;并在list_job()函数，list_jobs()函数，list_jobs_filter()函数，print_job()函数末尾分别加入如下代码&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#list_job()&#xA;ret = eval(encry_pass(str(ret)))   #增加此行&#xA;return ret&#xA;&#xA;#list_jobs()&#xA;mret = eval(encry_pass(str(mret)))    #增加此行&#xA;return mret&#xA;&#xA;#list_jobs_filter()&#xA;ret = eval(encry_pass(str(ret)))    #增加此行    &#xA;return ret&#xA;&#xA;#print_job()&#xA;ret = eval(encry_pass(str(ret)))    #增加此行&#xA;return ret&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;搞定&lt;/p&gt;&#xA;&lt;p&gt;一点小补充： 为什么要用&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;ret = eval(encry_pass(str(ret)))&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;因为ret是dict类型，得先把dict类型转换成str类型再写入encry_pass()正则匹配函数的参数里，然后encry_pass()正则匹配函数返回一个str对象，而ret需要的是dict对象，所以需要再用eval()转回来,也就是 ret(dict)&amp;mdash;-&amp;gt;str(ret)&amp;mdash;&amp;ndash;&amp;gt;ret(str)&amp;mdash;&amp;ndash;&amp;gt;result(str)&amp;mdash;&amp;ndash;&amp;gt;eval(result)&amp;mdash;&amp;ndash;&amp;gt;result(dict)&amp;mdash;&amp;ndash;&amp;gt;ret(dict)&lt;/p&gt;</description>
        </item><item>
            <title>NFS搭建及端口安全控制</title>
            <link>http://localhost:1313/posts/2017/12/2017-12-05-nfs%E6%90%AD%E5%BB%BA%E5%8F%8A%E7%AB%AF%E5%8F%A3%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/</link>
            <pubDate>Tue, 05 Dec 2017 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2017/12/2017-12-05-nfs%E6%90%AD%E5%BB%BA%E5%8F%8A%E7%AB%AF%E5%8F%A3%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/</guid>
            <description>&lt;p&gt;NFS服务用于文件分享和文件同步，功能就不描述了，架构是C/S的模式&lt;/p&gt;&#xA;&lt;p&gt;一.简单配置&lt;/p&gt;&#xA;&lt;p&gt;1.服务端&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;apt install nfs-kernel-server&#xA;vi /etc/exports&#xA;########添加如下#######&#xA;/opt/nfs *(ro,sync,no_subtree_check)&#xA;#NFS共享路径 IP(只读，同步，不检查父目录)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;service nfs-kernel-server restart &#xA;service rpcbind restart&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;测试：showmount -e&lt;/p&gt;&#xA;&lt;p&gt;2.客户端&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;apt-get install nfs-common&#xA;mount 远程nfs_ip:/路径 /本地路径&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt;二.NFS服务端口控制&lt;/p&gt;&#xA;&lt;p&gt;服务端配置：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# /etc/default/nfs-common&#xA; STATDOPTS=&amp;#34;--port 32765 --outgoing-port 32766&amp;#34;&#xA;&#xA; # /etc/default/nfs-kernel-server&#xA; RPCMOUNTDOPTS=&amp;#34;-p 32767&amp;#34;&#xA;&#xA; # /etc/default/quota&#xA; RPCRQUOTADOPTS=&amp;#34;-p 32769&amp;#34;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt; # /etc/sysctl.conf&#xA;fs.nfs.nfs_callback_tcpport = 32764&#xA;fs.nfs.nlm_tcpport = 32768&#xA;fs.nfs.nlm_udpport = 32768&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;sysctl --system&#xA;service nfs-kernel-server restart&#xA;service rpcbind restart&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;则可以将服务端端口限制为:&lt;/p&gt;&#xA;&lt;p&gt;2049,111,32764-32769 TCP/UDP&lt;/p&gt;</description>
        </item><item>
            <title>扩展并修改bash源码使支持rsyslog且增加审计条目</title>
            <link>http://localhost:1313/posts/2017/09/2017-09-13-%E6%89%A9%E5%B1%95%E5%B9%B6%E4%BF%AE%E6%94%B9bash%E6%BA%90%E7%A0%81%E4%BD%BF%E6%94%AF%E6%8C%81rsyslog%E4%B8%94%E5%A2%9E%E5%8A%A0%E5%AE%A1%E8%AE%A1%E6%9D%A1%E7%9B%AE/</link>
            <pubDate>Wed, 13 Sep 2017 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2017/09/2017-09-13-%E6%89%A9%E5%B1%95%E5%B9%B6%E4%BF%AE%E6%94%B9bash%E6%BA%90%E7%A0%81%E4%BD%BF%E6%94%AF%E6%8C%81rsyslog%E4%B8%94%E5%A2%9E%E5%8A%A0%E5%AE%A1%E8%AE%A1%E6%9D%A1%E7%9B%AE/</guid>
            <description>&lt;p&gt;最终效果： log记录: /var/log/messages&lt;/p&gt;&#xA;&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2017/09/1.png&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/1.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;history记录: history&lt;/p&gt;&#xA;&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2017/09/2-1.jpg&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/2-1.jpg&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;首先去gnu下载最新版的bash源码，本次采用的是bash-4.4版本&lt;/p&gt;&#xA;&lt;p&gt;编辑config-top.h文件，主要关注以下两点: 一.103行，取消&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#define SSH_SOURCE_BASHRC&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的注释 二.116行，取消&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#define SYSLOG_HISTORY&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的注释&lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt;然后编辑bashhist.c源码文件，主要关注750行-&amp;gt;800行。 未经修改的原文件：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;void&#xA;bash_syslog_history (line)&#xA;     const char *line;&#xA;{&#xA;  char trunc[SYSLOG_MAXLEN];&#xA;  static int first = 1;&#xA;&#xA;  if (first)&#xA;    {&#xA;      openlog (shell_name, OPENLOG_OPTS, SYSLOG_FACILITY);&#xA;      first = 0;&#xA;    }&#xA;&#xA;  if (strlen(line) &amp;lt; SYSLOG_MAXLEN)&#xA;    syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY: PID=%d UID=%d %s&amp;#34;, getpid(), current_user.uid, line);&#xA;  else&#xA;    {&#xA;      strncpy (trunc, line, SYSLOG_MAXLEN);&#xA;      trunc[SYSLOG_MAXLEN - 1] = &amp;#39;\0&amp;#39;;&#xA;      syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY (TRUNCATED): PID=%d UID=%d %s&amp;#34;, getpid(), current_user.uid, trunc);&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里主要就是用来修改syslog服务的相关记录项，可以增删功能。 修改后的代码：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;bash_syslog_history (line)&#xA;     const char *line;&#xA;{&#xA;  char trunc[SYSLOG_MAXLEN];&#xA;  static int first = 1;&#xA;  FILE *fp;&#xA;  char buffer[LEN_p];&#xA;  fp=popen(&amp;#34;echo \&amp;#34;[`who am i 2&amp;gt;/dev/null| awk &amp;#39;{print $NF}&amp;#39;|sed -e &amp;#39;s/ [()]//g&amp;#39;|sed &amp;#39;s/(//g&amp;#39;|sed &amp;#39;s/)//g&amp;#39;`]\&amp;#34;&amp;#34;,&amp;#34;r&amp;#34;);&#xA;  fgets(buffer,sizeof(buffer),fp);&#xA;  int ii = LEN_p-1;&#xA;  while(ii&amp;gt;=0 &amp;amp;&amp;amp; buffer[ii]==&amp;#39; &amp;#39;)&#xA;  ii--;&#xA;  buffer[ii] = &amp;#39;\0&amp;#39;;&#xA;  char buffer_test[LEN_p];&#xA;  int iii = 0;&#xA;  int jjj = 0;&#xA;  while(buffer[iii]!=&amp;#39;\0&amp;#39;){&#xA;   if(buffer[iii]&amp;lt;32)&#xA;     iii++;&#xA;    else&#xA;     buffer_test[jjj++]=buffer[iii++];&#xA;&#xA;  }&#xA;  buffer_test[jjj]=&amp;#39;\0&amp;#39;;&#xA;  //const char *buffer_test;&#xA;  //buffer_test = buffer;&#xA;  pclose(fp);&#xA;  //buffer_test = getenv(&amp;#34;NAME_OF_KEY&amp;#34;);&#xA;  if (first)&#xA;    {&#xA;      openlog (shell_name, OPENLOG_OPTS, SYSLOG_FACILITY);&#xA;      first = 0;&#xA;    }&#xA;&#xA;  if (strlen(line) &amp;lt; SYSLOG_MAXLEN)&#xA;    syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY: PID=%d UID=%d User=%s KEY=%s CMD=%s&amp;#34;, getpid(), current_user.uid, current_user.user_name, buffer_test,line);&#xA;  else&#xA;    {&#xA;      strncpy (trunc, line, SYSLOG_MAXLEN);&#xA;      trunc[SYSLOG_MAXLEN - 1] = &amp;#39;\0&amp;#39;;&#xA;      syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY (TRUNCATED): PID=%d UID=%d User=%s KEY=%s CMD=%s&amp;#34;, getpid(), current_user.uid, current_user.user_name, buffer_test,trunc);&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里既是通过修改源码的方法添加了审计username和IP的功能，如需要加入其他任何功能直接在这里写C代码就可以了。 然后，有唯一一个需要注意的要点，rsyslog处理所有ascii&amp;lt;32的特殊字符都会显示#012无法识别，所以无论用rsyslog记录什么，都需要把ascii&amp;lt;32的特殊字符删除掉 然后编译，替换/bin/bash不再多说&lt;/p&gt;&#xA;&lt;p&gt;最后，可以编辑/etc/profile，修改环境变量，添加如下三行常用配置：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;export HISTTIMEFORMAT=&amp;#34;[%Y-%m-%d %H:%M:%S] [`who am i 2&amp;gt;/dev/null| awk &amp;#39;{print $NF}&amp;#39;|sed -e &amp;#39;s/[    ()]//g&amp;#39;`] &amp;#34;&#xA;export HISTSIZE=&amp;#34;999999&amp;#34;&#xA;readonly PROMPT_COMMAND=&amp;#34;history -a&amp;#34;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;第一行定义history格式 第二行第一history最大存储 第三行让所有用户操作都能即时写入history中，而不是退出session时再写入(如果同时又几个用户登录，可能导致history事件错乱)&lt;/p&gt;</description>
        </item></channel>
</rss>
