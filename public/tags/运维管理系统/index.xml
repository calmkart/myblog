<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>运维管理系统 on cAlm的个人Blog</title>
        <link>http://localhost:1313/tags/%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/</link>
        <description>Recent content in 运维管理系统 on cAlm的个人Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Thu, 02 Aug 2018 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/index.xml" rel="self" type="application/rss+xml" /><item>
            <title>记一次立竿见影的性能优化</title>
            <link>http://localhost:1313/posts/2018/08/2018-08-02-%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AB%8B%E7%AB%BF%E8%A7%81%E5%BD%B1%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</link>
            <pubDate>Thu, 02 Aug 2018 00:00:00 +0000</pubDate>
            <guid>http://localhost:1313/posts/2018/08/2018-08-02-%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AB%8B%E7%AB%BF%E8%A7%81%E5%BD%B1%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</guid>
            <description>&lt;p&gt;通过一点细微代码的修改,将某系统首页载入时间缩短了10倍有余.&lt;/p&gt;&#xA;&lt;p&gt;系统首页大致这样&lt;/p&gt;&#xA;&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/08/201882204014dama.png&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/201882204014dama.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;逻辑是读取后台的所有服务列表,判断用户是否有权限,有权限则交给前端用ztree显示,并可进行部署操作,但因为服务太多,遍历服务后判断用户是否有权限后台耗时太长,用chrome查了下,后台数据处理费时2000ms,这样首页就载入的太慢了.&lt;/p&gt;&#xA;&lt;p&gt;第一步,查代码,原始代码如下:&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;@login_required&#xA;def services(request):&#xA;    user = request.user&#xA;    _online_apps = App.objects.filter(app_env=&amp;#39;online&amp;#39;)&#xA;    _test_apps = App.objects.filter(app_env=&amp;#39;test&amp;#39;)&#xA;    _dev_apps = App.objects.filter(app_env=&amp;#39;dev&amp;#39;)&#xA;&#xA;    online_apps = [a for a in _online_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]&#xA;    test_apps = [a for a in _test_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]&#xA;    dev_apps = [a for a in _dev_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]&#xA;&#xA;    online_apps_name = [{&amp;#39;name&amp;#39;:app.app_name, &amp;#39;id&amp;#39;:app.id} for app in online_apps]&#xA;    test_apps_name = [{&amp;#39;name&amp;#39;:app.app_name, &amp;#39;id&amp;#39;:app.id} for app in test_apps]&#xA;    dev_apps_name = [{&amp;#39;name&amp;#39;:app.app_name, &amp;#39;id&amp;#39;:app.id} for app in dev_apps]&#xA;    nodes = [&#xA;                {&amp;#39;name&amp;#39;:&amp;#39;online&amp;#39;,&#xA;                 &amp;#39;open&amp;#39;:&amp;#39;true&amp;#39;,&#xA;                 &amp;#39;children&amp;#39;:online_apps_name&#xA;                },&#xA;                {&amp;#39;name&amp;#39;:&amp;#39;test&amp;#39;,&#xA;                 &amp;#39;open&amp;#39;:&amp;#39;false&amp;#39;,&#xA;                 &amp;#39;children&amp;#39;:test_apps_name&#xA;                },&#xA;                {&amp;#39;name&amp;#39;:&amp;#39;dev&amp;#39;,&#xA;                 &amp;#39;open&amp;#39;:&amp;#39;false&amp;#39;,&#xA;                 &amp;#39;children&amp;#39;:dev_apps_name&#xA;                }&#xA;    ];&#xA;    return render(request, &amp;#39;services/services.html&amp;#39;, {&amp;#39;nodes&amp;#39;: json.dumps(nodes)})&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;也没什么复杂的,就是django models + django-guardian权限控制,然后返回数据给ztree生成树结构.&lt;/p&gt;&#xA;&lt;p&gt;初步设想是因为列表生成式太多导致速度慢,写测试代码做测试&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;python manage.py shell&#xA;&#xA;&amp;gt;&amp;gt;&amp;gt; import time&#xA;&amp;gt;&amp;gt;&amp;gt; from django.contrib.auth.models import User&#xA;&amp;gt;&amp;gt;&amp;gt; from services.views import new_service&#xA;&amp;gt;&amp;gt;&amp;gt; def test(user):&#xA;...     start = time.time()&#xA;...     new_service(user)&#xA;...     stop = time.time()&#xA;...     print stop-start&#xA;...&#xA;&amp;gt;&amp;gt;&amp;gt; pengng = User.objects.get(name=&amp;#39;pengng&amp;#39;)&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.93502497673&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.89282894135&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;2.14076519012&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.85515809059&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.91108703613&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;发现处理时间大致在1.8-1.9s之间,然后直接将上述原始代码第一步拆了出来&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#仅测试这一步&#xA;online_apps = [a for a in _online_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]&#xA;&#xA;#发现时间在1.2秒左右&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.25127100945&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.27178192139&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.22848701477&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;1.25300002098&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;继续分拆,发现是这个user.has_perm(&amp;lsquo;deploy_perm&amp;rsquo;,a)的guardian获取权限消耗了大量的时间 然后想起这个系统里权限都是以group来赋权的,获取用户对于服务的权限要先经过组再到服务,先遍历服务再单独查看用户是否有该组权限导致重复遍历太多,其实直接获取用户对应的所有拥有权限的服务对象即可(get_objects_for_user()方法),尝试修改代码&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;@login_required&#xA;def services(request):&#xA;    user = request.user&#xA;&#xA;    if is_admin_by_group(user.username):&#xA;        online_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id}&#xA;                            for a in App.objects.filter(app_env=&amp;#39;online&amp;#39;)]&#xA;        test_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id}&#xA;                          for a in App.objects.filter(app_env=&amp;#39;test&amp;#39;)]&#xA;        dev_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id}&#xA;                         for a in App.objects.filter(app_env=&amp;#39;dev&amp;#39;)]&#xA;    else:&#xA;        online_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id} for a in get_objects_for_user(&#xA;            user, &amp;#39;deploy_perm&amp;#39;, klass=App) if a.app_env == &amp;#34;online&amp;#34;]&#xA;        test_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id} for a in get_objects_for_user(&#xA;            user, &amp;#39;deploy_perm&amp;#39;, klass=App) if a.app_env == &amp;#34;test&amp;#34;]&#xA;        dev_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id} for a in get_objects_for_user(&#xA;            user, &amp;#39;deploy_perm&amp;#39;, klass=App) if a.app_env == &amp;#34;dev&amp;#34;]&#xA;&#xA;    nodes = [&#xA;        {&amp;#39;name&amp;#39;: &amp;#39;online&amp;#39;,&#xA;                 &amp;#39;open&amp;#39;: &amp;#39;true&amp;#39;,&#xA;                 &amp;#39;children&amp;#39;: online_apps_name&#xA;         },&#xA;        {&amp;#39;name&amp;#39;: &amp;#39;test&amp;#39;,&#xA;                 &amp;#39;open&amp;#39;: &amp;#39;false&amp;#39;,&#xA;                 &amp;#39;children&amp;#39;: test_apps_name&#xA;         },&#xA;        {&amp;#39;name&amp;#39;: &amp;#39;dev&amp;#39;,&#xA;                 &amp;#39;open&amp;#39;: &amp;#39;false&amp;#39;,&#xA;                 &amp;#39;children&amp;#39;: dev_apps_name&#xA;         }&#xA;    ]&#xA;    return render(request, &amp;#39;services/services.html&amp;#39;, {&amp;#39;nodes&amp;#39;: json.dumps(nodes)})&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后重载文件&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; reload(services.views)&#xA;&amp;lt;module &amp;#39;services.views&amp;#39; from &amp;#39;/home/**/***/services/views.py&amp;#39;&amp;gt;&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;0.0817279815674&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;0.0788700580597&#xA;&amp;gt;&amp;gt;&amp;gt; test(pengng)&#xA;0.0756318569183&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;立竿见影,瞬间从2秒降低到了0.08秒左右 &lt;a class=&#34;link&#34; href=&#34;http://www.calmkart.com/wp-content/uploads/2018/08/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_008058b2-bd81-4a9c-8442-63afc75ac870.png&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;&#xA;    &gt;&lt;img src=&#34;images/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_008058b2-bd81-4a9c-8442-63afc75ac870.png&#34; alt=&#34;&#34; /&gt;&#xA;&lt;/a&gt;收工&lt;/p&gt;</description>
        </item></channel>
</rss>
