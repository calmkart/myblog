<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ldap on cAlm的个人Blog</title><link>https://www.calmkart.com/tags/ldap/</link><description>Recent content in Ldap on cAlm的个人Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 28 Sep 2018 00:00:00 +0000</lastBuildDate><atom:link href="https://www.calmkart.com/tags/ldap/index.xml" rel="self" type="application/rss+xml"/><item><title>python操作ldap</title><link>https://www.calmkart.com/posts/2018/09/2018-09-28-python%E6%93%8D%E4%BD%9Cldap/</link><pubDate>Fri, 28 Sep 2018 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2018/09/2018-09-28-python%E6%93%8D%E4%BD%9Cldap/</guid><description>&lt;p&gt;封装了一个python的ldap常用操作类&lt;/p&gt;
&lt;p&gt;首先pip装库&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;pip install python-ldap
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后开始代码部分&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;# -*- coding:utf-8 -*-
from __future__ import absolute_import

import binascii
import hashlib
from base64 import b64encode

import ldap
import ldap.modlist as modlist

from common.common import log

class MyLdap():
 
 def __init__(self,ldap_host=None,base_dn=None,user=None,password=None):
 self.base_dn = base_dn
 self.ldap_host = ldap_host
 self.user = user
 self.password = password
 try:
 self.ldapconn = ldap.initialize(ldap_host)
 self.ldapconn.simple_bind(user,password)
 except ldap.LDAPError,e:
 log().error(str(e))
 print e

 @property
 def status(self):
 &amp;#39;&amp;#39;&amp;#39;
 验证初始化ldap账号密码,以及ldap地址是否正确
 &amp;#39;&amp;#39;&amp;#39;
 ldap_client = ldap.initialize(self.ldap_host)
 try:
 ldap_client.simple_bind_s(self.user, self.password)
 ldap_client.unbind_s()
 return {&amp;#34;status&amp;#34;:True}
 except Exception as e:
 log().error(str(e))
 return {&amp;#34;status&amp;#34;:False, &amp;#34;msg&amp;#34;:&amp;#34;ldap初始化管理员账号密码或ldap地址有误,详情:{0}&amp;#34;.format(str(e))}

 def _ldap_search_dn(self,uid=None):
 obj = self.ldapconn
 obj.protocal_version = ldap.VERSION3
 searchScope = ldap.SCOPE_SUBTREE
 retrieveAttributes = None 
 searchFilter = &amp;#34;cn=&amp;#34; + uid
 
 try:
 ldap_result_id = obj.search(self.base_dn, searchScope, searchFilter, retrieveAttributes)
 result_type, result_data = obj.result(ldap_result_id, 0)
 if result_type == ldap.RES_SEARCH_ENTRY:
 return result_data[0][0]
 else:
 return None
 except ldap.LDAPError, e:
 log().error(str(e))

 def ldap_get_user(self,uid=None):
 &amp;#39;&amp;#39;&amp;#39;
 获取ldap用户详情,失败返None
 &amp;#39;&amp;#39;&amp;#39;
 obj = self.ldapconn
 obj.protocal_version = ldap.VERSION3
 searchScope = ldap.SCOPE_SUBTREE
 retrieveAttributes = None 
 searchFilter = &amp;#34;cn=&amp;#34; + uid
 try:
 ldap_result_id = obj.search(self.base_dn, searchScope, searchFilter, retrieveAttributes)
 result_type, result_data = obj.result(ldap_result_id, 0)
 if result_type == ldap.RES_SEARCH_ENTRY:
 username = result_data[0][1][&amp;#39;cn&amp;#39;][0]
 mail = result_data[0][1][&amp;#39;mail&amp;#39;][0]
 displayName = result_data[0][1][&amp;#39;displayName&amp;#39;][0]
 sn = result_data[0][1][&amp;#39;sn&amp;#39;][0]
 result = {&amp;#39;username&amp;#39;:username,&amp;#39;mail&amp;#39;:mail,&amp;#39;displayName&amp;#39;:displayName, &amp;#39;sn&amp;#39;:sn}
 return result
 else:
 return None
 except ldap.LDAPError, e:
 log().error(str(e))
 
 def ldap_get(self,uid=None,passwd=None):
 &amp;#39;&amp;#39;&amp;#39;
 验证ldap账号密码,成功返True,失败返False
 &amp;#39;&amp;#39;&amp;#39;
 target_cn = self._ldap_search_dn(uid)
 if not target_cn:
 return False 
 try:
 client = ldap.initialize(self.ldap_host)
 client.simple_bind_s(target_cn,passwd)
 client.unbind_s()
 return True
 except ldap.LDAPError,e:
 log().error(str(e))
 return False

 
 def cnupdatepass(self, cn, passwd):
 &amp;#39;&amp;#39;&amp;#39;
 更改ldap密码,成功返True,失败返error
 &amp;#39;&amp;#39;&amp;#39;
 dn=&amp;#39;cn={0},{1}&amp;#39;.format(cn, self.base_dn)
 try:
 result=self.ldapconn.search_s(dn, ldap.SCOPE_SUBTREE, &amp;#39;cn=%s&amp;#39; % cn)
 oldpass=result[0][1][&amp;#39;userPassword&amp;#39;]
 oldwifipass=result[0][1][&amp;#39;sambaNTPassword&amp;#39;]
 newpass=&amp;#39;{MD5}&amp;#39; + b64encode(hashlib.md5(passwd).digest())
 wifipass=binascii.hexlify(hashlib.new(&amp;#39;md4&amp;#39;, passwd.encode(&amp;#39;utf-16le&amp;#39;)).digest())
 old={&amp;#39;userPassword&amp;#39;:oldpass,&amp;#39;sambaNTPassword&amp;#39;: oldwifipass}
 new={&amp;#34;sambaNTPassword&amp;#34;: [wifipass],&amp;#34;userPassword&amp;#34;:[newpass]}
 mlist = modlist.modifyModlist(old, new)
 self.ldapconn.modify_s(dn, mlist)
 return {&amp;#34;status&amp;#34;:True}
 except ldap.LDAPError as e:
 log().error(str(e))
 return {&amp;#34;status&amp;#34;:False, &amp;#34;msg&amp;#34;:&amp;#34;ldap更改密码错误,详情: {0}&amp;#34;.format(str(e))}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;使用时&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;ldap_client = MyLdap(ldap_url, base_dn, admin, password)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;代码注释已经写的很清楚了感觉,不再写详情了,本文做个备忘&lt;/p&gt;</description></item></channel></rss>