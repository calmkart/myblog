<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Guardian on cAlm的个人Blog</title><link>https://www.calmkart.com/tags/guardian/</link><description>Recent content in Guardian on cAlm的个人Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 02 Aug 2018 00:00:00 +0000</lastBuildDate><atom:link href="https://www.calmkart.com/tags/guardian/index.xml" rel="self" type="application/rss+xml"/><item><title>记一次立竿见影的性能优化</title><link>https://www.calmkart.com/posts/2018/08/2018-08-02-%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AB%8B%E7%AB%BF%E8%A7%81%E5%BD%B1%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</link><pubDate>Thu, 02 Aug 2018 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2018/08/2018-08-02-%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AB%8B%E7%AB%BF%E8%A7%81%E5%BD%B1%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</guid><description>&lt;p&gt;通过一点细微代码的修改,将某系统首页载入时间缩短了10倍有余.&lt;/p&gt;
&lt;p&gt;系统首页大致这样&lt;/p&gt;
&lt;p&gt;&lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2018/08/201882204014dama.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/201882204014dama.png" alt="" /&gt;
&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;逻辑是读取后台的所有服务列表,判断用户是否有权限,有权限则交给前端用ztree显示,并可进行部署操作,但因为服务太多,遍历服务后判断用户是否有权限后台耗时太长,用chrome查了下,后台数据处理费时2000ms,这样首页就载入的太慢了.&lt;/p&gt;
&lt;p&gt;第一步,查代码,原始代码如下:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;@login_required
def services(request):
 user = request.user
 _online_apps = App.objects.filter(app_env=&amp;#39;online&amp;#39;)
 _test_apps = App.objects.filter(app_env=&amp;#39;test&amp;#39;)
 _dev_apps = App.objects.filter(app_env=&amp;#39;dev&amp;#39;)

 online_apps = [a for a in _online_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]
 test_apps = [a for a in _test_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]
 dev_apps = [a for a in _dev_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]

 online_apps_name = [{&amp;#39;name&amp;#39;:app.app_name, &amp;#39;id&amp;#39;:app.id} for app in online_apps]
 test_apps_name = [{&amp;#39;name&amp;#39;:app.app_name, &amp;#39;id&amp;#39;:app.id} for app in test_apps]
 dev_apps_name = [{&amp;#39;name&amp;#39;:app.app_name, &amp;#39;id&amp;#39;:app.id} for app in dev_apps]
 nodes = [
 {&amp;#39;name&amp;#39;:&amp;#39;online&amp;#39;,
 &amp;#39;open&amp;#39;:&amp;#39;true&amp;#39;,
 &amp;#39;children&amp;#39;:online_apps_name
 },
 {&amp;#39;name&amp;#39;:&amp;#39;test&amp;#39;,
 &amp;#39;open&amp;#39;:&amp;#39;false&amp;#39;,
 &amp;#39;children&amp;#39;:test_apps_name
 },
 {&amp;#39;name&amp;#39;:&amp;#39;dev&amp;#39;,
 &amp;#39;open&amp;#39;:&amp;#39;false&amp;#39;,
 &amp;#39;children&amp;#39;:dev_apps_name
 }
 ];
 return render(request, &amp;#39;services/services.html&amp;#39;, {&amp;#39;nodes&amp;#39;: json.dumps(nodes)})
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;也没什么复杂的,就是django models + django-guardian权限控制,然后返回数据给ztree生成树结构.&lt;/p&gt;
&lt;p&gt;初步设想是因为列表生成式太多导致速度慢,写测试代码做测试&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;python manage.py shell

&amp;gt;&amp;gt;&amp;gt; import time
&amp;gt;&amp;gt;&amp;gt; from django.contrib.auth.models import User
&amp;gt;&amp;gt;&amp;gt; from services.views import new_service
&amp;gt;&amp;gt;&amp;gt; def test(user):
... start = time.time()
... new_service(user)
... stop = time.time()
... print stop-start
...
&amp;gt;&amp;gt;&amp;gt; pengng = User.objects.get(name=&amp;#39;pengng&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.93502497673
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.89282894135
&amp;gt;&amp;gt;&amp;gt; test(pengng)
2.14076519012
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.85515809059
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.91108703613
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;发现处理时间大致在1.8-1.9s之间,然后直接将上述原始代码第一步拆了出来&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;#仅测试这一步
online_apps = [a for a in _online_apps if user.has_perm(&amp;#39;deploy_perm&amp;#39;, a) or is_admin_by_group(user.username)]

#发现时间在1.2秒左右
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.25127100945
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.27178192139
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.22848701477
&amp;gt;&amp;gt;&amp;gt; test(pengng)
1.25300002098
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;继续分拆,发现是这个user.has_perm(&amp;lsquo;deploy_perm&amp;rsquo;,a)的guardian获取权限消耗了大量的时间 然后想起这个系统里权限都是以group来赋权的,获取用户对于服务的权限要先经过组再到服务,先遍历服务再单独查看用户是否有该组权限导致重复遍历太多,其实直接获取用户对应的所有拥有权限的服务对象即可(get_objects_for_user()方法),尝试修改代码&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;@login_required
def services(request):
 user = request.user

 if is_admin_by_group(user.username):
 online_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id}
 for a in App.objects.filter(app_env=&amp;#39;online&amp;#39;)]
 test_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id}
 for a in App.objects.filter(app_env=&amp;#39;test&amp;#39;)]
 dev_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id}
 for a in App.objects.filter(app_env=&amp;#39;dev&amp;#39;)]
 else:
 online_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id} for a in get_objects_for_user(
 user, &amp;#39;deploy_perm&amp;#39;, klass=App) if a.app_env == &amp;#34;online&amp;#34;]
 test_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id} for a in get_objects_for_user(
 user, &amp;#39;deploy_perm&amp;#39;, klass=App) if a.app_env == &amp;#34;test&amp;#34;]
 dev_apps_name = [{&amp;#39;name&amp;#39;: a.app_name, &amp;#39;id&amp;#39;: a.id} for a in get_objects_for_user(
 user, &amp;#39;deploy_perm&amp;#39;, klass=App) if a.app_env == &amp;#34;dev&amp;#34;]

 nodes = [
 {&amp;#39;name&amp;#39;: &amp;#39;online&amp;#39;,
 &amp;#39;open&amp;#39;: &amp;#39;true&amp;#39;,
 &amp;#39;children&amp;#39;: online_apps_name
 },
 {&amp;#39;name&amp;#39;: &amp;#39;test&amp;#39;,
 &amp;#39;open&amp;#39;: &amp;#39;false&amp;#39;,
 &amp;#39;children&amp;#39;: test_apps_name
 },
 {&amp;#39;name&amp;#39;: &amp;#39;dev&amp;#39;,
 &amp;#39;open&amp;#39;: &amp;#39;false&amp;#39;,
 &amp;#39;children&amp;#39;: dev_apps_name
 }
 ]
 return render(request, &amp;#39;services/services.html&amp;#39;, {&amp;#39;nodes&amp;#39;: json.dumps(nodes)})
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后重载文件&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; reload(services.views)
&amp;lt;module &amp;#39;services.views&amp;#39; from &amp;#39;/home/**/***/services/views.py&amp;#39;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; test(pengng)
0.0817279815674
&amp;gt;&amp;gt;&amp;gt; test(pengng)
0.0788700580597
&amp;gt;&amp;gt;&amp;gt; test(pengng)
0.0756318569183
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;立竿见影,瞬间从2秒降低到了0.08秒左右 &lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2018/08/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_008058b2-bd81-4a9c-8442-63afc75ac870.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_008058b2-bd81-4a9c-8442-63afc75ac870.png" alt="" /&gt;
&lt;/a&gt;收工&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="历史评论-5-条"&gt;历史评论 (5 条)
&lt;/h2&gt;&lt;p&gt;&lt;em&gt;以下评论来自原 WordPress 站点，仅作存档展示。&lt;/em&gt;&lt;/p&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;安全黄&lt;/strong&gt; (2018-08-06 11:56)&lt;/p&gt;
&lt;p&gt;给大佬递槟榔&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;↳ &lt;strong&gt;calmkart&lt;/strong&gt; (2018-08-13 15:03)&lt;/p&gt;
&lt;p&gt;安全王牛瘪！安全王请带我飞！&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;杨硕&lt;/strong&gt; (2018-08-09 17:23)&lt;/p&gt;
&lt;p&gt;大哥喝冰可乐，psc快收了我啊&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;↳ &lt;strong&gt;calmkart&lt;/strong&gt; (2018-08-13 15:03)&lt;/p&gt;
&lt;p&gt;就等着xsc上市了&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;吃瓜群众&lt;/strong&gt; (2018-11-07 10:31)&lt;/p&gt;
&lt;p&gt;您的文章写得真好，给大佬倒橙汁&lt;/p&gt;

 &lt;/blockquote&gt;</description></item></channel></rss>