<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>C on cAlm的个人Blog</title><link>https://www.calmkart.com/tags/c/</link><description>Recent content in C on cAlm的个人Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Wed, 13 Sep 2017 00:00:00 +0000</lastBuildDate><atom:link href="https://www.calmkart.com/tags/c/index.xml" rel="self" type="application/rss+xml"/><item><title>扩展并修改bash源码使支持rsyslog且增加审计条目</title><link>https://www.calmkart.com/posts/2017/09/2017-09-13-%E6%89%A9%E5%B1%95%E5%B9%B6%E4%BF%AE%E6%94%B9bash%E6%BA%90%E7%A0%81%E4%BD%BF%E6%94%AF%E6%8C%81rsyslog%E4%B8%94%E5%A2%9E%E5%8A%A0%E5%AE%A1%E8%AE%A1%E6%9D%A1%E7%9B%AE/</link><pubDate>Wed, 13 Sep 2017 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2017/09/2017-09-13-%E6%89%A9%E5%B1%95%E5%B9%B6%E4%BF%AE%E6%94%B9bash%E6%BA%90%E7%A0%81%E4%BD%BF%E6%94%AF%E6%8C%81rsyslog%E4%B8%94%E5%A2%9E%E5%8A%A0%E5%AE%A1%E8%AE%A1%E6%9D%A1%E7%9B%AE/</guid><description>&lt;p&gt;最终效果： log记录: /var/log/messages&lt;/p&gt;
&lt;p&gt;&lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2017/09/1.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/1.png" alt="" /&gt;
&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;history记录: history&lt;/p&gt;
&lt;p&gt;&lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2017/09/2-1.jpg" target="_blank" rel="noopener"
 &gt;&lt;img src="images/2-1.jpg" alt="" /&gt;
&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;首先去gnu下载最新版的bash源码，本次采用的是bash-4.4版本&lt;/p&gt;
&lt;p&gt;编辑config-top.h文件，主要关注以下两点: 一.103行，取消&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;#define SSH_SOURCE_BASHRC
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的注释 二.116行，取消&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;#define SYSLOG_HISTORY
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;的注释&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;然后编辑bashhist.c源码文件，主要关注750行-&amp;gt;800行。 未经修改的原文件：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;void
bash_syslog_history (line)
 const char *line;
{
 char trunc[SYSLOG_MAXLEN];
 static int first = 1;

 if (first)
 {
 openlog (shell_name, OPENLOG_OPTS, SYSLOG_FACILITY);
 first = 0;
 }

 if (strlen(line) &amp;lt; SYSLOG_MAXLEN)
 syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY: PID=%d UID=%d %s&amp;#34;, getpid(), current_user.uid, line);
 else
 {
 strncpy (trunc, line, SYSLOG_MAXLEN);
 trunc[SYSLOG_MAXLEN - 1] = &amp;#39;\0&amp;#39;;
 syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY (TRUNCATED): PID=%d UID=%d %s&amp;#34;, getpid(), current_user.uid, trunc);
 }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里主要就是用来修改syslog服务的相关记录项，可以增删功能。 修改后的代码：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;bash_syslog_history (line)
 const char *line;
{
 char trunc[SYSLOG_MAXLEN];
 static int first = 1;
 FILE *fp;
 char buffer[LEN_p];
 fp=popen(&amp;#34;echo \&amp;#34;[`who am i 2&amp;gt;/dev/null| awk &amp;#39;{print $NF}&amp;#39;|sed -e &amp;#39;s/ [()]//g&amp;#39;|sed &amp;#39;s/(//g&amp;#39;|sed &amp;#39;s/)//g&amp;#39;`]\&amp;#34;&amp;#34;,&amp;#34;r&amp;#34;);
 fgets(buffer,sizeof(buffer),fp);
 int ii = LEN_p-1;
 while(ii&amp;gt;=0 &amp;amp;&amp;amp; buffer[ii]==&amp;#39; &amp;#39;)
 ii--;
 buffer[ii] = &amp;#39;\0&amp;#39;;
 char buffer_test[LEN_p];
 int iii = 0;
 int jjj = 0;
 while(buffer[iii]!=&amp;#39;\0&amp;#39;){
 if(buffer[iii]&amp;lt;32)
 iii++;
 else
 buffer_test[jjj++]=buffer[iii++];

 }
 buffer_test[jjj]=&amp;#39;\0&amp;#39;;
 //const char *buffer_test;
 //buffer_test = buffer;
 pclose(fp);
 //buffer_test = getenv(&amp;#34;NAME_OF_KEY&amp;#34;);
 if (first)
 {
 openlog (shell_name, OPENLOG_OPTS, SYSLOG_FACILITY);
 first = 0;
 }

 if (strlen(line) &amp;lt; SYSLOG_MAXLEN)
 syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY: PID=%d UID=%d User=%s KEY=%s CMD=%s&amp;#34;, getpid(), current_user.uid, current_user.user_name, buffer_test,line);
 else
 {
 strncpy (trunc, line, SYSLOG_MAXLEN);
 trunc[SYSLOG_MAXLEN - 1] = &amp;#39;\0&amp;#39;;
 syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, &amp;#34;HISTORY (TRUNCATED): PID=%d UID=%d User=%s KEY=%s CMD=%s&amp;#34;, getpid(), current_user.uid, current_user.user_name, buffer_test,trunc);
 }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里既是通过修改源码的方法添加了审计username和IP的功能，如需要加入其他任何功能直接在这里写C代码就可以了。 然后，有唯一一个需要注意的要点，rsyslog处理所有ascii&amp;lt;32的特殊字符都会显示#012无法识别，所以无论用rsyslog记录什么，都需要把ascii&amp;lt;32的特殊字符删除掉 然后编译，替换/bin/bash不再多说&lt;/p&gt;
&lt;p&gt;最后，可以编辑/etc/profile，修改环境变量，添加如下三行常用配置：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;export HISTTIMEFORMAT=&amp;#34;[%Y-%m-%d %H:%M:%S] [`who am i 2&amp;gt;/dev/null| awk &amp;#39;{print $NF}&amp;#39;|sed -e &amp;#39;s/[ ()]//g&amp;#39;`] &amp;#34;
export HISTSIZE=&amp;#34;999999&amp;#34;
readonly PROMPT_COMMAND=&amp;#34;history -a&amp;#34;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;第一行定义history格式 第二行第一history最大存储 第三行让所有用户操作都能即时写入history中，而不是退出session时再写入(如果同时又几个用户登录，可能导致history事件错乱)&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="历史评论-3-条"&gt;历史评论 (3 条)
&lt;/h2&gt;&lt;p&gt;&lt;em&gt;以下评论来自原 WordPress 站点，仅作存档展示。&lt;/em&gt;&lt;/p&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;请叫我总裁谢&lt;/strong&gt; (2017-09-18 18:18)&lt;/p&gt;
&lt;p&gt;我日，彭总不亏是全国pythone第一人，技术博客吊炸天，在下是服的&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;孙昊&lt;/strong&gt; (2017-10-31 14:12)&lt;/p&gt;
&lt;p&gt;彭总，快更新文章啊！！！！！！！&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;Huanguo&lt;/strong&gt; (2017-11-10 17:23)&lt;/p&gt;
&lt;p&gt;dalao,dalao&lt;/p&gt;

 &lt;/blockquote&gt;</description></item></channel></rss>