<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Zabbix on cAlm的个人Blog</title><link>https://www.calmkart.com/tags/zabbix/</link><description>Recent content in Zabbix on cAlm的个人Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Wed, 27 Dec 2017 00:00:00 +0000</lastBuildDate><atom:link href="https://www.calmkart.com/tags/zabbix/index.xml" rel="self" type="application/rss+xml"/><item><title>使用zabbix api提取趋势(trend)和历史(history)数据</title><link>https://www.calmkart.com/posts/2017/12/2017-12-27-%E4%BD%BF%E7%94%A8zabbix-api%E6%8F%90%E5%8F%96%E8%B6%8B%E5%8A%BFtrend%E5%92%8C%E5%8E%86%E5%8F%B2history%E6%95%B0%E6%8D%AE/</link><pubDate>Wed, 27 Dec 2017 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2017/12/2017-12-27-%E4%BD%BF%E7%94%A8zabbix-api%E6%8F%90%E5%8F%96%E8%B6%8B%E5%8A%BFtrend%E5%92%8C%E5%8E%86%E5%8F%B2history%E6%95%B0%E6%8D%AE/</guid><description>&lt;p&gt;zabbix restful api说明见官网文档 &lt;a class="link" href="https://www.zabbix.com/documentation/4.0/zh/manual/api/reference/apiinfo" target="_blank" rel="noopener"
 &gt;https://www.zabbix.com/documentation/4.0/zh/manual/api/reference/apiinfo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;使用了github上封装好的python zabbix api,免去了自己造轮子的过程 &lt;a class="link" href="https://github.com/lukecyca/pyzabbix" target="_blank" rel="noopener"
 &gt;https://github.com/lukecyca/pyzabbix&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这个封装的python zabbix api实现起来也比较简单，主要是用缺省的类__getattr__()方法，调用zabbix的restful api&lt;/p&gt;
&lt;p&gt;首先用pip安装pyzabbix&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;pip install pyzabbix
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;具体实现获取trend和history代码如下:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;#---coding:utf-8---

from pyzabbix import ZabbixAPI
import time
class get_net(object):
	url = &amp;#34;&amp;#34;
	username = None
	password = None

	def __init__(self, server, user, passwd):
		self.url = &amp;#34;http://&amp;#34;+server+&amp;#34;/zabbix&amp;#34;
		self.username = user
		self.password = passwd

	def get_trend(self, info_list):
		z = ZabbixAPI(self.url)
		z.login(self.username,self.password)
		for info in info_list:
			hosts = z.host.get(filter={&amp;#34;host&amp;#34;:info[&amp;#34;ip&amp;#34;]})
			if hosts:
				host_id = hosts[0][&amp;#34;hostid&amp;#34;]
			print host_id
			items = z.item.get(hostids=host_id,filter={&amp;#34;key_&amp;#34;:&amp;#34;ifHCOutOctets[&amp;#34;+info[&amp;#34;interface&amp;#34;]+&amp;#34;]&amp;#34;})[0]
			if items:
				item_id = items[&amp;#34;itemid&amp;#34;]
			trend = z.trend.get(itemids=item_id)
			for td in trend:
				clock = self.get_clock(td[&amp;#39;clock&amp;#39;])
				if (&amp;#34;20:00&amp;#34; in clock) or (&amp;#34;21:00&amp;#34; in clock) or (&amp;#34;22:00&amp;#34; in clock):
					print clock+&amp;#34; &amp;#34;+str(int(td[&amp;#34;value_avg&amp;#34;])*8/1048576)
					f = open(info[&amp;#34;name&amp;#34;],&amp;#34;a&amp;#34;)
					f.write(clock+&amp;#34; &amp;#34;+str(int(td[&amp;#34;value_avg&amp;#34;])*8/1048576))
					f.write(&amp;#34;\n&amp;#34;)
			f.close()

	def get_history(self, info_list):
		z = ZabbixAPI(self.url)
		z.login(self.username,self.password)
		for info in info_list:
			hosts = z.host.get(filter={&amp;#34;host&amp;#34;:info[&amp;#34;ip&amp;#34;]})
			if hosts:
				host_id = hosts[0][&amp;#34;hostid&amp;#34;]
			print host_id
			items = z.item.get(hostids=host_id,filter={&amp;#34;key_&amp;#34;:&amp;#34;ifHCOutOctets[&amp;#34;+info[&amp;#34;interface&amp;#34;]+&amp;#34;]&amp;#34;})[0]
			if items:
				item_id = items[&amp;#34;itemid&amp;#34;]
			history = z.history.get(itemids=item_id,time_from=1512129600)
			r_t = []
			print history
			for hs in history:
				clock = self.get_clock(hs[&amp;#39;clock&amp;#39;])
				if (&amp;#34;20:&amp;#34; in clock) or (&amp;#34;21:&amp;#34; in clock) or (&amp;#34;22:&amp;#34; in clock):
					print clock+&amp;#34; &amp;#34;+str(int(hs[&amp;#34;value&amp;#34;])/1048576)
					r_t.append(clock+&amp;#34; &amp;#34;+str(int(hs[&amp;#34;value&amp;#34;])/1048576))
			r_t_str = &amp;#34;\n&amp;#34;.join(r_t)
			f = open(&amp;#34;test_history&amp;#34;,&amp;#34;a&amp;#34;)
			f.write(r_t_str)
			f.close()
	
	def get_clock(self, value):
		clock = time.localtime(int(value))
		format = &amp;#39;%Y-%m-%d %H:%M&amp;#39;
		return time.strftime(format,clock)

#test = get_net(&amp;#34;zabbix服务器IP&amp;#34;, &amp;#34;user&amp;#34;, &amp;#34;pass&amp;#34;)
#test.get_trend([{&amp;#34;ip&amp;#34;:&amp;#34;机器IP&amp;#34;,&amp;#34;name&amp;#34;:&amp;#34;某机器&amp;#34;,&amp;#34;interface&amp;#34;:&amp;#34;某接口名&amp;#34;}])
#test.get_trend(info列表，格式如上)
#test.get_history([{&amp;#34;ip&amp;#34;:&amp;#34;机器IP&amp;#34;,&amp;#34;name&amp;#34;:&amp;#34;某机器&amp;#34;,&amp;#34;interface&amp;#34;:&amp;#34;某接口名&amp;#34;}])
#test.get_history(info列表，格式如上)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;注： 其中get_clock()函数用于做linux时间戳转换。&lt;/p&gt;</description></item><item><title>zabbix报警收敛</title><link>https://www.calmkart.com/posts/2017/08/2017-08-23-zabbix%E6%8A%A5%E8%AD%A6%E6%94%B6%E6%95%9B/</link><pubDate>Wed, 23 Aug 2017 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2017/08/2017-08-23-zabbix%E6%8A%A5%E8%AD%A6%E6%94%B6%E6%95%9B/</guid><description>&lt;p&gt;因zabbix可能同一段时间报警过多，接受消息时如果不做收敛可能出错也不容易审查，所以需要一个报警收敛机制。&lt;/p&gt;
&lt;p&gt;实验环境分为server端与client端： server端模拟收敛程序通过TCP SOCKET连接接受zabbix报警，做收敛处理并发送； client端模拟zabbix报警程序，通过TCP SOCKET连接发送模拟的zabbix报警给server;&lt;/p&gt;
&lt;p&gt;server端程序如下：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;# -*- coding:utf-8 -*-
from threading import Timer
import urllib2
import socket
import threading
import re

#event_list为收敛类型数目列表
#ip_list为IP收敛字典列表
#summary为收敛类型说明列表
#keyw为正则匹配元素

class convergence(object):
	event_list = [0,0,0,0]
	summary = [&amp;#39;获取uptime时间失败&amp;#39;,&amp;#39;SNMP_cant_respond_for_5minutes错误&amp;#39;,&amp;#39;OK错误&amp;#39;,&amp;#39;流量速率异常错误&amp;#39;]
	ip_list = [{},{},{},{}]
	keyw = [&amp;#39;获取uptime时间失败&amp;#39;,&amp;#39;SNMPcan\&amp;#39;trespondfor5minutes&amp;#39;,&amp;#39;ok&amp;#39;,&amp;#39;流量速度异常&amp;#39;]
	t = None
	
	def convergence(self,event):
		temp = self.keyword(event)
		ip = self.findip(event)
		if temp != 0:
			#做报警IP收敛
			if self.ip_list[temp-1].has_key(ip):
				self.ip_list[temp-1][ip] = self.ip_list[temp-1][ip]+1
			else:
				self.ip_list[temp-1][ip] = 1
			#做报警条目收敛
			self.event_list[temp-1] = self.event_list[temp-1]+1
			if self.t == None:
				self.timer(event)
			else:
				pass
		
		else:
			#按原格式发送
			print event
			pass

	def send(self,event):
		print &amp;#39;目前的缓存区为&amp;#39;+str(self.event_list)
		if max(self.event_list) == 0:
			pass
		else:
			for i in range(0,len(event_list)):
				if self.event_list[i]==0:
					pass
				else:#发送收敛后的报警到指定位置
					content = str(event_list[i]+&amp;#39;次&amp;#39;+self.summary[i]+&amp;#39;(前20秒内)&amp;#39;)
					self.event_list[i] = 0
					self.t = None
					urllib2.urlopen(&amp;#39;http://www.calmkart.com&amp;#39;)
					print content

	def timer(self,event):#启动定时器
		self.t = Timer(20,self.send,args=[event])
		self.t.start()
	
	def keyword(self,event):
		for i in range(0,len(self.keyw)):
			if re.search(self.keyw[i],event,flags=re.IGNORECASE) != None:
				return i+1
		return 0
	
	def findip(self,event):
		m = re.search(r&amp;#39;(?&amp;lt;![\.\d])(?:\d{1,3}\.){3}\d{1,3}(?![\.\d])&amp;#39;,event)
		if m is not None:
			ip = m.group()
			return str(ip)
		return &amp;#39;查不到IP&amp;#39;

test = convergence()

#tcp测试,server端，接收
host = &amp;#39;0.0.0.0&amp;#39;
port = 9001
s = socket.socket()
s.bind((host,port))
s.listen(5)

while True:
	c,addr = s.accept()
	data = c.recv(1024)
	test.convergence(data)
	
##udp测试,server端，接收
#s= socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
#host = &amp;#39;10.17.16.207&amp;#39;
#port = 9001
#s.bind((host,port))
#
#while True:
#	data,addr = s.recvfrom(2048)
#	test.convergence(data)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;clent端程序如下：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;# --- coding:utf-8 ---
import random
from multiprocessing.connection import Client

str1 = [
	&amp;#39;192.168.0.1SNMP错误&amp;#39;,
 &amp;#39;192.168.0.2SNMP错误&amp;#39;,
 &amp;#39;192.168.0.100,OK&amp;#39;,
 &amp;#39;192.168.0.101,ok&amp;#39;,
	&amp;#39;192.168.0.102,流量速率异常&amp;#39;,
	&amp;#39;192.168.0.103,流量速率异常&amp;#39;,
	&amp;#39;192.168.0.104,获取uptime时间失败&amp;#39;,
	&amp;#39;192.168.0.105,获取uptime时间失败&amp;#39;
] 
address = (&amp;#39;0.0.0.0&amp;#39;,9001)

for i in range(0,1000):
	m = str1[random.randrange(0,11)]
	conn = Client(address)
	conn.send(m)
	conn.close
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;主要用到的工具是正则表达式做匹配&lt;/p&gt;
&lt;p&gt;代码已上传至github,地址 &lt;a class="link" href="https://github.com/calmkart/Zabbix_convergence" target="_blank" rel="noopener"
 &gt;https://github.com/calmkart/Zabbix_convergence&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="历史评论-1-条"&gt;历史评论 (1 条)
&lt;/h2&gt;&lt;p&gt;&lt;em&gt;以下评论来自原 WordPress 站点，仅作存档展示。&lt;/em&gt;&lt;/p&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;我有一个可爱的小椰子&lt;/strong&gt; (2017-08-29 20:39)&lt;/p&gt;
&lt;p&gt;厉害了，过来学习一下&lt;/p&gt;

 &lt;/blockquote&gt;</description></item><item><title>windows配置snmp v3监控(net-snmp)</title><link>https://www.calmkart.com/posts/2017/08/2017-08-10-windows%E9%85%8D%E7%BD%AEsnmp-v3%E7%9B%91%E6%8E%A7net-snmp/</link><pubDate>Thu, 10 Aug 2017 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2017/08/2017-08-10-windows%E9%85%8D%E7%BD%AEsnmp-v3%E7%9B%91%E6%8E%A7net-snmp/</guid><description>&lt;p&gt;因为windows本身是不支持snmp v3的，所以需要第三方工具的帮助 这里我们选择常用的net-snmp&lt;/p&gt;
&lt;h4 id="步骤"&gt;&lt;strong&gt;步骤：&lt;/strong&gt;
&lt;/h4&gt;&lt;p&gt;1.关闭本系统中的SNMP服务&lt;/p&gt;
&lt;p&gt;2.安装vc x64库&lt;/p&gt;
&lt;p&gt;3.安装openssl x64版本(最新版本)&lt;/p&gt;
&lt;p&gt;4.解压openssl 0.9.8zf x64版，将ssleay32.dll和libeay32.dll复制进c:/windows/system32和c:/windows/syswow64 里，替换原文件&lt;/p&gt;
&lt;p&gt;5.安装net-snmp-5.5.0-2.x64版本的net-snmp，记得勾选with windows extension dll support和encryption support(openssl)选项(WINDOWS DLL可以开启一些不能使用的功能，encrytion support才可以开启登录且验证的SNMP V3功能)&lt;/p&gt;
&lt;p&gt;6.安装activeperl，默认安装既可&lt;/p&gt;
&lt;p&gt;7.运行c:/usr/registeragent.bat 把SNMP V3服务进行注册&lt;/p&gt;
&lt;p&gt;8.编写 c:\usr\etc\snmp\snmpd.conf 配置文件，这里我用的配置如下（细节不赘述）&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;agentAddress udp:0.0.0.0:161
createUser authPrivUser SHA &amp;#34;passwordauthprivuser&amp;#34; DES
# Full read-only access for SNMPv3
# Full write access for encrypted requests
# Remember to activate the &amp;#39;createUser&amp;#39; lines above
rouser authPrivUser priv
sysLocation Sitting on the Dock of the Bay
sysContact Me &amp;lt;me@example.org&amp;gt;
# Application + End-to-End layers
sysServices 72
# At least one &amp;#39;mountd&amp;#39; process
proc mountd
# No more than 4 &amp;#39;ntalkd&amp;#39; processes - 0 is OK
proc ntalkd 4
# At least one &amp;#39;sendmail&amp;#39; process, but no more than 10
proc sendmail 10 1
# 10MBs required on root disk, 5% free on /var, 10% free on all other disks
#disk / 10000
#disk /var 5%
#includeAllDisks 10%
# Unacceptable 1-, 5-, and 15-minute load averages
load 12 10 5
# send SNMPv2c traps
# send SNMPv2c INFORMs
# Remember to activate the &amp;#39;createUser&amp;#39; lines above
iquerySecName internalUser 
rouser internalUser
# generate traps on UCD error conditions
defaultMonitors yes
# generate traps on linkUp/Down
linkUpDownNotifications yes
# Run as an AgentX master agent
master agentx
# Listen for network connections (from localhost)
# rather than the default named socket /var/agentx/master
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id="测试"&gt;&lt;strong&gt;测试：&lt;/strong&gt;
&lt;/h4&gt;&lt;p&gt;snmp v3 安全级别有三种，分别为 noAuthNoPriv（不认证也不加密）、authNoPriv（认证但是不加密）、 authPriv（既认证又加密）&lt;/p&gt;
&lt;p&gt;&lt;img src="images/uYrkAw4K6DZqj3vdzfAOg.png" alt="" /&gt;
&lt;/p&gt;
&lt;p&gt;常见的 SNMP OID列表 监控需要用到的OID如下连接:&lt;/p&gt;
&lt;p&gt;&lt;a class="link" href="http://www.ttlsa.com/monitor/snmp-oid/" target="_blank" rel="noopener"
 &gt;http://www.ttlsa.com/monitor/snmp-oid/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;本次整个配置过程所有程序安装包在此下载:&lt;/p&gt;
&lt;p&gt;&lt;a class="link" href="http://www.calmkart.com/snmp_v3_allinone.rar" target="_blank" rel="noopener"
 &gt;http://www.calmkart.com/snmp_v3_allinone.rar&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="历史评论-3-条"&gt;历史评论 (3 条)
&lt;/h2&gt;&lt;p&gt;&lt;em&gt;以下评论来自原 WordPress 站点，仅作存档展示。&lt;/em&gt;&lt;/p&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;华为谢的总&lt;/strong&gt; (2017-08-14 16:53)&lt;/p&gt;
&lt;p&gt;彭总666&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;门面の霸&lt;/strong&gt; (2017-08-15 11:54)&lt;/p&gt;
&lt;p&gt;彭总吊炸天&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;Ares&lt;/strong&gt; (2020-03-16 09:43)&lt;/p&gt;
&lt;p&gt;谢谢啊只不过找到的有点迟了，参考了这个https://syesilbulut.blogspot.com/2015/04/net-snmp-step-by-step-installation.html 搞完了发现你这个了 完了重新安装了一遍&lt;/p&gt;

 &lt;/blockquote&gt;</description></item></channel></rss>