<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Rook on cAlm的个人Blog</title><link>https://www.calmkart.com/tags/rook/</link><description>Recent content in Rook on cAlm的个人Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 24 May 2019 00:00:00 +0000</lastBuildDate><atom:link href="https://www.calmkart.com/tags/rook/index.xml" rel="self" type="application/rss+xml"/><item><title>kubernetes搭建并使用rook/ceph的pv存储</title><link>https://www.calmkart.com/posts/2019/05/2019-05-24-kubernetes%E6%90%AD%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8rook-ceph%E7%9A%84pv%E5%AD%98%E5%82%A8/</link><pubDate>Fri, 24 May 2019 00:00:00 +0000</pubDate><guid>https://www.calmkart.com/posts/2019/05/2019-05-24-kubernetes%E6%90%AD%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8rook-ceph%E7%9A%84pv%E5%AD%98%E5%82%A8/</guid><description>&lt;p&gt;k8s中pod的存储在非单节点是不支持hostpath的，都得用各种分布式存储来实现.每个pvc对应的pv手工创建也很不现实,试了下rook-ceph分布式存储的搞法，感觉不错.其中也还是遇到了很多坑,这里稍微记录一下.&lt;/p&gt;
&lt;p&gt;首先有一个三个节点的k8s集群 &lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2019/05/111.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/111.png" alt="" /&gt;
&lt;/a&gt; 首先创建rook-ceph-common&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;wget https://raw.githubusercontent.com/rook/rook/master/cluster/examples/kubernetes/ceph/common.yaml
kubectl apply -f common.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后创建rook-ceph-operator&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;wget https://raw.githubusercontent.com/rook/rook/release-1.0/cluster/examples/kubernetes/ceph/operator.yaml
kubectl apply -f operator.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;以上两步基本上不会出啥问题,标准配置 接下来创建cluster的问题比较多,贴上我的配置&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;vim cluster.yaml

apiVersion: ceph.rook.io/v1
kind: CephCluster
metadata:
 name: rook-ceph
 namespace: rook-ceph
spec:
 cephVersion:
 image: ceph/ceph:v14.2.1-20190430
 allowUnsupported: true
 #设置data路径到自己规划的路径
 dataDirHostPath: /home/shared/rook
 mon:
 count: 3
 allowMultiplePerNode: true
 dashboard:
 enabled: true
 port: 8443
 urlPrefix: /
 #关闭https
 ssl: false
 network:
 #如要在k8s集群外使用,这里可以打开
 hostNetwork: false
 rbdMirroring:
 workers: 0
 storage:
 #全节点使用
 useAllNodes: true
 useAllDevices: false
 deviceFilter:
 config:
 osdsPerDevice: &amp;#34;1&amp;#34;
 directories:
 - path: /home/shared/rook
&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex="0"&gt;&lt;code&gt;kubectl apply -f cluster.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;查看部署情况 &lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2019/05/2.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/2.png" alt="" /&gt;
&lt;/a&gt; 这样就基本上没问题了,k8s中的每个Node会启两个pod(rook-ceph-agent和rook-discover),并且mgr和osd都没问题。 然后给ceph-dashboard提供NodePort的外部访问service&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;vim dashboard-external-http.yaml

apiVersion: v1
kind: Service
metadata:
 name: rook-ceph-mgr-dashboard-external-https
 namespace: rook-ceph
 labels:
 app: rook-ceph-mgr
 rook_cluster: rook-ceph
spec:
 ports:
 - name: dashboard
 port: 8443
 protocol: TCP
 targetPort: 8443
 selector:
 app: rook-ceph-mgr
 rook_cluster: rook-ceph
 sessionAffinity: None
 type: NodePort
&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex="0"&gt;&lt;code&gt;kubectl apply -f dashboard-external-https.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后查看下service的情况,是否正常 &lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2019/05/3.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/3.png" alt="" /&gt;
&lt;/a&gt; 这样就对了,可以访问一下http://&lt;!-- raw HTML omitted --&gt;:&lt;!-- raw HTML omitted --&gt;，看看是不是能进ceph-dashboard&lt;/p&gt;
&lt;p&gt;一般情况下问题不大,查看admin的默认密码&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=&amp;#34;{[&amp;#39;data&amp;#39;][&amp;#39;password&amp;#39;]}&amp;#34; | base64 --decode &amp;amp;&amp;amp; echo
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;但是admin登陆进去了之后，肯定会疯狂500错误，查了下官方的issue，这里有bug。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决办法是:&lt;/strong&gt; &lt;strong&gt;在dashboard里创建一个新role角色(右上角用户管理,roles)，把权限全钩上，然后去掉iscsi的所有权限。&lt;/strong&gt; &lt;strong&gt;接着创建一个新用户,绑定这个新的role角色,最后用新用户登陆&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;接着创建pool和storage用于自动生成pvc匹配的pv&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;vim storageclass.yaml

apiVersion: ceph.rook.io/v1
kind: CephBlockPool
metadata:
 name: replicapool
 namespace: rook-ceph
spec:
 replicated:
 size: 2
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
 name: rook-ceph-block
provisioner: ceph.rook.io/block
parameters:
 blockPool: replicapool
 clusterNamespace: rook-ceph
 fstype: xfs
&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex="0"&gt;&lt;code&gt;kubectl apply -f storagecalss.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;创建pool和storage之后通过dashboard或者命令 kubectl get cephcluster -n rook-ceph 查看一下集群是否health，如果是health就没毛病了&lt;/p&gt;
&lt;p&gt;最后测试一下申请一个pvc看看是否会自动生成pv与之绑定&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;apiVersion: v1
kind: PersistentVolumeClaim
metadata:
 name: jenkins-home
 namespace: kube-ops
 labels:
 app: jenkins-home
spec:
 storageClassName: rook-ceph-block
 accessModes:
 - ReadWriteOnce
 resources:
 requests:
 storage: 20Gi
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;a class="link" href="http://www.calmkart.com/wp-content/uploads/2019/05/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_dd2a2f8b-10fb-4f3f-8d21-bbaa31a4ba7d.png" target="_blank" rel="noopener"
 &gt;&lt;img src="images/%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e6%88%aa%e5%9b%be_dd2a2f8b-10fb-4f3f-8d21-bbaa31a4ba7d.png" alt="" /&gt;
&lt;/a&gt; 可见，管用了.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;外加一些小tips:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;如果rook-ceph配置有误需要还原重新配置,一定要遵循官方的清理步骤 &lt;a class="link" href="https://rook.github.io/docs/rook/v1.0/ceph-teardown.html" target="_blank" rel="noopener"
 &gt;https://rook.github.io/docs/rook/v1.0/ceph-teardown.html&lt;/a&gt; 切记要删除掉所有k8s的node上配置的data文件夹,不然会导致新集群无法初始化.&lt;/p&gt;
&lt;p&gt;创建不出pod很多都是权限原因或者node无法调度,需要检查下rbac权限设置或者各个node的情况.&lt;/p&gt;
&lt;p&gt;最后附上rook项目的github地址: &lt;a class="link" href="https://github.com/rook/rook" target="_blank" rel="noopener"
 &gt;https://github.com/rook/rook&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="历史评论-2-条"&gt;历史评论 (2 条)
&lt;/h2&gt;&lt;p&gt;&lt;em&gt;以下评论来自原 WordPress 站点，仅作存档展示。&lt;/em&gt;&lt;/p&gt;

 &lt;blockquote&gt;
 &lt;p&gt;&lt;strong&gt;huan&lt;/strong&gt; (2019-05-28 16:30)&lt;/p&gt;
&lt;p&gt;大佬又开始搞K8S，我要跟着学习学习&lt;/p&gt;

 &lt;/blockquote&gt;

 &lt;blockquote&gt;
 &lt;p&gt;↳ &lt;strong&gt;calmkart&lt;/strong&gt; (2019-05-29 17:06)&lt;/p&gt;
&lt;p&gt;学学学,建议买课,极客时间张磊博士的深入剖析k8s很好&lt;/p&gt;

 &lt;/blockquote&gt;</description></item></channel></rss>